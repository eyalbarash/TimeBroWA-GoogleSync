{% extends "base.html" %}

{% block title %}× ×™×”×•×œ ×§×‘×•×¦×•×ª{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-users-cog me-2"></i>
            × ×™×”×•×œ ×§×‘×•×¦×•×ª
        </h2>
        <p class="text-muted">×—×¤×© ×•×¡× ×Ÿ ××ª ×”×§×‘×•×¦×•×ª ×©×œ×š, ×•×‘×—×¨ ××™×œ×• ×§×‘×•×¦×•×ª ×™×›× ×¡×• ×œ×™×•××Ÿ TimeBro</p>
    </div>
</div>

<!-- ×˜××‘×™× -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="true">
            <i class="fas fa-users me-1"></i>×§×‘×•×¦×•×ª
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
            <i class="fas fa-file-alt me-1"></i>×œ×•×’×™×
        </button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- ×˜××‘ ×§×‘×•×¦×•×ª -->
    <div class="tab-pane fade show active" id="groups" role="tabpanel" aria-labelledby="groups-tab">

<!-- ×˜×•×¤×¡ ×—×™×¤×•×© -->
<div class="search-form">
    <form id="search-form-groups">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="search-term-groups" class="form-label">
                    <i class="fas fa-search me-1"></i>×—×™×¤×•×© ×œ×¤×™ ×©× ×§×‘×•×¦×”
                </label>
                <input type="text" class="form-control" id="search-term-groups" placeholder="×”×–×Ÿ ×©× ×§×‘×•×¦×” ×œ×—×™×¤×•×©...">
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    <i class="fas fa-filter me-1"></i>×¤×™×œ×˜×¨×™×
                </label>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="calendar-only-groups">
                        <label class="form-check-label" for="calendar-only-groups">
                            <i class="fas fa-calendar-check me-1"></i>××¡×•×× ×•×ª ×œ×™×•××Ÿ ×‘×œ×‘×“
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="date-from-groups" class="form-label">
                    <i class="fas fa-calendar me-1"></i>××ª××¨×™×š
                </label>
                <input type="date" class="form-control" id="date-from-groups">
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="date-to-groups" class="form-label">
                    <i class="fas fa-calendar me-1"></i>×¢×“ ×ª××¨×™×š
                </label>
                <input type="date" class="form-control" id="date-to-groups">
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>×—×¤×©
                    </button>
                    <button type="button" class="btn btn-secondary" id="clear-search-groups">
                        <i class="fas fa-times me-1"></i>× ×§×”
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Loading -->
<div class="loading" id="loading-groups">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">×˜×•×¢×Ÿ...</span>
    </div>
    <p class="mt-2">×˜×•×¢×Ÿ ×§×‘×•×¦×•×ª...</p>
    <p class="text-muted small">××¦×™×’ ××ª ×›×œ ×”×§×‘×•×¦×•×ª ×©×œ×š</p>
</div>

<!-- ×ª×•×¦××•×ª -->
<div id="results-container-groups" style="display: block;">
    <!-- ×›×•×ª×¨×ª ×ª×•×¦××•×ª -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="results-title-groups">×ª×•×¦××•×ª ×—×™×¤×•×©</h4>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-success btn-sm" id="select-all-calendar-groups">
                <i class="fas fa-check-double me-1"></i>×‘×—×¨ ×”×›×œ ×œ×™×•××Ÿ
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="deselect-all-calendar-groups">
                <i class="fas fa-times me-1"></i>×‘×˜×œ ×‘×—×™×¨×ª ×”×›×œ
            </button>
        </div>
    </div>

    <!-- ×˜×‘×œ×ª ×ª×•×¦××•×ª -->
    <div class="results-table">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>×©× ×§×‘×•×¦×”</th>
                        <th>×ª×™××•×¨</th>
                        <th>×©× ×—×‘×¨×”</th>
                        <th>××©×ª×ª×¤×™×</th>
                        <th>×‘×¢×œ×™×</th>
                        <th>× ×•×¦×¨</th>
                        <th>× ×•×¡×£ ×œ××¢×¨×›×ª</th>
                        <th>×›×œ×•×œ ×‘×™×•××Ÿ</th>
                        <th>×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ</th>
                        <th>×¡× ×›×¨×•×Ÿ</th>
                    </tr>
                </thead>
                <tbody id="results-tbody-groups">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <nav>
            <ul class="pagination justify-content-center" id="pagination-groups">
            </ul>
        </nav>
        <p class="text-muted" id="results-info-groups"></p>
    </div>
</div>

<!-- ×”×•×“×¢×” ×× ××™×Ÿ ×ª×•×¦××•×ª -->
<div id="no-results-groups" style="display: none;">
    <div class="alert alert-info text-center">
        <i class="fas fa-search fa-2x mb-3"></i>
        <h5>×œ× × ××¦××• ×ª×•×¦××•×ª</h5>
        <p>× ×¡×” ×œ×©× ×•×ª ××ª ×§×¨×™×˜×¨×™×•× ×™ ×”×—×™×¤×•×©</p>
    </div>
</div>

<!-- ×¤×•×¤××¤ ×‘×—×™×¨×ª ×ª×§×•×¤×” -->
<div class="modal fade" id="syncModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync me-2"></i>×‘×—×™×¨×ª ×ª×§×•×¤×ª ×¡×™× ×›×¨×•×Ÿ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sync-form">
                    <input type="hidden" id="sync-item-id">
                    <input type="hidden" id="sync-item-type">
                    
                    <div class="mb-3">
                        <label for="sync-start-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>××ª××¨×™×š
                        </label>
                        <input type="date" class="form-control" id="sync-start-date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sync-end-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>×¢×“ ×ª××¨×™×š
                        </label>
                        <input type="date" class="form-control" id="sync-end-date" required>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>××™×“×¢:</strong> ×”×¡×™× ×›×¨×•×Ÿ ×™×›×œ×•×œ ×”×•×“×¢×•×ª ×˜×§×¡×˜ ×‘×œ×‘×“ ×•×™×•×¡×™×£ ××™×¨×•×¢×™× ×œ×™×•××Ÿ Google.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="confirm-sync">
                    <i class="fas fa-sync me-1"></i>×”×ª×—×œ ×¡×™× ×›×¨×•×Ÿ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ×¤×•×¤××¤ ×”×ª×§×“××•×ª ×¡×™× ×›×¨×•×Ÿ -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync fa-spin me-2"></i>××¡× ×›×¨×Ÿ...
                </h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="minimize-sync">
                    <i class="fas fa-window-minimize"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progress-text">××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ...</div>
                <div id="progress-details" class="mt-2"></div>
                
                <!-- ×œ×•×’×™× ××¤×•×¨×˜×™× -->
                <div class="mt-3">
                    <h6><i class="fas fa-list me-2"></i>×œ×•×’ ×¤×¢×™×œ×•×ª:</h6>
                    <div id="sync-logs" class="bg-dark text-light p-2 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div class="text-success">[××ª×—×™×œ] ××¢×¨×›×ª ×¡×™× ×›×¨×•×Ÿ ×”×•×¤×¢×œ×”...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-sync-modal" style="display: none;">
                    <i class="fas fa-times me-1"></i>×¡×’×•×¨
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ×—×œ×•×Ÿ ××•×§×˜×Ÿ ×œ×¡×™× ×›×¨×•×Ÿ -->
<div id="minimized-sync" class="position-fixed bottom-0 end-0 p-3" style="display: none; z-index: 1050;">
    <div class="card shadow" style="width: 300px;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-sync fa-spin me-2"></i>××¡× ×›×¨×Ÿ...
            </h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="restore-sync">
                <i class="fas fa-window-restore"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div id="minimized-progress-text" class="small">××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ...</div>
        </div>
    </div>
</div>

    <!-- ×˜××‘ ×œ×•×’×™× -->
    <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
        <div class="row">
            <div class="col-12">
                <h3>
                    <i class="fas fa-file-alt me-2"></i>
                    ×œ×•×’×™× ×©×œ ×”××¢×¨×›×ª
                </h3>
                <p class="text-muted">×¦×¤×™×™×” ×‘×œ×•×’×™× ×©×œ ×¤×¢×•×œ×•×ª ×”××¢×¨×›×ª ×‘×–××Ÿ ×××ª</p>
            </div>
        </div>

        <!-- ×‘×§×¨×•×ª ×œ×•×’×™× -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" id="refresh-logs">
                        <i class="fas fa-sync-alt me-1"></i>×¨×¢× ×Ÿ ×œ×•×’×™×
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="clear-logs">
                        <i class="fas fa-trash me-1"></i>× ×§×” ××¡×š
                    </button>
                    <button type="button" class="btn btn-outline-info" id="auto-refresh-toggle">
                        <i class="fas fa-play me-1"></i>×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <select class="form-select" id="log-level-filter">
                        <option value="all">×›×œ ×”×¨××•×ª</option>
                        <option value="INFO">××™×“×¢</option>
                        <option value="WARNING">××–×”×¨×”</option>
                        <option value="ERROR">×©×’×™××”</option>
                        <option value="DEBUG">×“×™×‘×•×’</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ××–×•×¨ ×”×œ×•×’×™× -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-1"></i>
                            ×œ×•×’×™×
                        </h5>
                        <small class="text-muted" id="log-count">0 ×”×•×“×¢×•×ª</small>
                    </div>
                    <div class="card-body p-0">
                        <div id="logs-container" class="logs-container">
                            <div class="text-center text-muted p-4">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                ×˜×•×¢×Ÿ ×œ×•×’×™×...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.logs-container {
    height: 500px;
    overflow-y: auto;
    background-color: #1e1e1e;
    color: #ffffff;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    padding: 15px;
    border-radius: 0 0 0.375rem 0.375rem;
}

.log-entry {
    margin-bottom: 8px;
    padding: 5px 8px;
    border-radius: 3px;
    border-left: 3px solid transparent;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.log-entry.INFO {
    border-left-color: #17a2b8;
    background-color: rgba(23, 162, 184, 0.1);
}

.log-entry.WARNING {
    border-left-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.log-entry.ERROR {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
    color: #ff6b6b;
}

.log-entry.DEBUG {
    border-left-color: #6c757d;
    background-color: rgba(108, 117, 125, 0.1);
    color: #adb5bd;
}

.log-timestamp {
    color: #6c757d;
    font-size: 11px;
    margin-right: 10px;
}

.log-level {
    font-weight: bold;
    margin-right: 10px;
    min-width: 60px;
    display: inline-block;
}

.log-message {
    color: #ffffff;
}

.auto-refresh-active {
    background-color: #28a745 !important;
    color: white !important;
}

.auto-refresh-active i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.logs-container::-webkit-scrollbar {
    width: 8px;
}

.logs-container::-webkit-scrollbar-track {
    background: #2d2d2d;
}

.logs-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.logs-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentPageGroups = 1;
let currentFiltersGroups = {};

// ×¤×•×¨××˜ ×ª××¨×™×š - ××•×’×“×¨ ×’×œ×•×‘×œ×™×ª
function formatDate(dateString) {
    if (!dateString) return '×œ× ×™×“×•×¢';
    
    // ×˜×™×¤×•×œ ×‘×ª××¨×™×›×™× ×©×•× ×™×
    let date;
    if (typeof dateString === 'string') {
        // ×× ×–×” timestamp
        if (/^\d+$/.test(dateString)) {
            date = new Date(parseInt(dateString) * 1000);
        } else {
            date = new Date(dateString);
        }
    } else {
        date = new Date(dateString);
    }
    
    // ×‘×“×™×§×” ×× ×”×ª××¨×™×š ×ª×§×™×Ÿ
    if (isNaN(date.getTime())) {
        return '×œ× ×™×“×•×¢';
    }
    
    return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
}

// ×—×™×¤×•×© ×§×‘×•×¦×•×ª
function searchGroups(page = 1) {
    currentPageGroups = page;
    
    // ××™×¡×•×£ ×¤×¨××˜×¨×™ ×—×™×¤×•×©
    const params = {
        search: $('#search-term-groups').val(),
        date_from: $('#date-from-groups').val(),
        date_to: $('#date-to-groups').val(),
        calendar_only: $('#calendar-only-groups').is(':checked'),
        page: page,
        per_page: 50
    };
    
    currentFiltersGroups = params;
    
    $('#loading-groups').show();
    $('#results-container-groups, #no-results-groups').hide();
    
    $.get('/api/search/groups', params)
        .done(function(data) {
            $('#loading-groups').hide();
            
            if (data.error) {
                showAlert('×©×’×™××” ×‘×—×™×¤×•×©: ' + data.error, 'error');
                return;
            }
            
            if (data.groups && data.groups.length > 0) {
                displayGroupsResults(data);
            } else {
                $('#no-results-groups').show();
            }
        })
        .fail(function() {
            $('#loading-groups').hide();
            showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
        });
}

// ×”×¦×’×ª ×ª×•×¦××•×ª ×§×‘×•×¦×•×ª
function displayGroupsResults(data) {
    const tbody = $('#results-tbody-groups');
    tbody.empty();
    
    data.groups.forEach(function(group) {
        const row = createGroupRow(group);
        tbody.append(row);
    });
    
    // ×¢×“×›×•×Ÿ ××™×“×¢ ×ª×•×¦××•×ª
    const start = (data.page - 1) * data.per_page + 1;
    const end = Math.min(start + data.groups.length - 1, data.total);
    $('#results-info-groups').text(`××¦×™×’ ${start}-${end} ××ª×•×š ${data.total.toLocaleString()} ×ª×•×¦××•×ª`);
    $('#results-title-groups').text(`× ××¦××• ${data.total.toLocaleString()} ×§×‘×•×¦×•×ª`);
    
    // ×¢×“×›×•×Ÿ pagination
    updateGroupsPagination(data);
    
    $('#results-container-groups').show();
}

// ×™×¦×™×¨×ª ×©×•×¨×” ×‘×˜×‘×œ×ª ×§×‘×•×¦×•×ª
function createGroupRow(group) {
    const calendarButton = group.include_in_timebro ? 
        `<button class="btn btn-calendar-yes btn-sm toggle-calendar-group" data-id="${group.group_id}" data-status="1">
            <i class="fas fa-calendar-check me-1"></i>×›×œ×•×œ
        </button>` :
        `<button class="btn btn-calendar-no btn-sm toggle-calendar-group" data-id="${group.group_id}" data-status="0">
            <i class="fas fa-calendar-times me-1"></i>×œ× ×›×œ×•×œ
        </button>`;
    
    const description = group.description ? 
        (group.description.length > 50 ? group.description.substring(0, 50) + '...' : group.description) : 
        '×œ×œ× ×ª×™××•×¨';
    
    return `
        <tr data-group-id="${group.group_id}">
            <td>
                <strong>${group.subject || '×œ×œ× ×©×'}</strong>
            </td>
            <td>
                <span class="text-muted">${description}</span>
            </td>
            <td>
                <span class="company-name-editable-group" 
                      data-id="${group.group_id}" 
                      data-type="group"
                      style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;"
                      title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×”×—×‘×¨×”">
                    ${group.company_name || '×œ×—×¥ ×œ×”×’×“×¨×”'}
                </span>
            </td>
            <td>
                <span class="badge bg-info">${group.size || 0}</span>
            </td>
            <td>
                <small>${group.owner || '×œ× ×™×“×•×¢'}</small>
            </td>
            <td>
                <small>${formatDate(group.created_at)}</small>
            </td>
            <td>
                <small>${formatDate(group.updated_at)}</small>
            </td>
            <td>
                ${calendarButton}
            </td>
            <td>
                <div class="last-sync" id="last-sync-${group.id}">
                    <small class="text-muted">×˜×•×¢×Ÿ...</small>
                </div>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm sync-now" data-id="${group.id}" data-type="group">
                        <i class="fas fa-sync me-1"></i>×¡× ×›×¨×Ÿ ×¢×›×©×™×•
                    </button>
                    <button class="btn btn-danger btn-sm delete-group" data-id="${group.id}" data-name="${group.name || '×§×‘×•×¦×”'}">
                        <i class="fas fa-trash me-1"></i>××—×§
                    </button>
                </div>
                <div class="sync-status" id="sync-status-${group.id}" style="display: none;">
                    <small class="text-muted">××¡× ×›×¨×Ÿ...</small>
                </div>
            </td>
        </tr>
    `;
}

// ×¢×“×›×•×Ÿ pagination ×œ×§×‘×•×¦×•×ª
function updateGroupsPagination(data) {
    const pagination = $('#pagination-groups');
    pagination.empty();
    
    if (data.total_pages <= 1) return;
    
    // ×›×¤×ª×•×¨ ×”×§×•×“×
    if (data.page > 1) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchGroups(${data.page - 1})">×”×§×•×“×</a>
            </li>
        `);
    }
    
    // ××¡×¤×¨×™ ×¢××•×“×™×
    const startPage = Math.max(1, data.page - 2);
    const endPage = Math.min(data.total_pages, data.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === data.page ? 'active' : '';
        pagination.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="searchGroups(${i})">${i}</a>
            </li>
        `);
    }
    
    // ×›×¤×ª×•×¨ ×”×‘×
    if (data.page < data.total_pages) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchGroups(${data.page + 1})">×”×‘×</a>
            </li>
        `);
    }
}

// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×™×•××Ÿ ×œ×§×‘×•×¦×•×ª
function toggleGroupCalendarStatus(groupId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    
    $.ajax({
        url: `/api/update/group/${groupId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ include_in_timebro: newStatus === 1 }),
        success: function(response) {
            if (response.error) {
                showAlert('×©×’×™××” ×‘×¢×“×›×•×Ÿ: ' + response.error, 'error');
                return;
            }
            
            // ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨
            const button = $(`.toggle-calendar-group[data-id="${groupId}"]`);
            if (newStatus === 1) {
                button.removeClass('btn-calendar-no').addClass('btn-calendar-yes')
                      .attr('data-status', '1')
                      .html('<i class="fas fa-calendar-check me-1"></i>×›×œ×•×œ');
            } else {
                button.removeClass('btn-calendar-yes').addClass('btn-calendar-no')
                      .attr('data-status', '0')
                      .html('<i class="fas fa-calendar-times me-1"></i>×œ× ×›×œ×•×œ');
            }
            
            updateStats();
            showAlert('×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        },
        error: function() {
            showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
        }
    });
}

// ××™×¨×•×¢×™×
$(document).ready(function() {
    // ×—×™×¤×•×© ×‘×˜×•×¤×¡
    $('#search-form-groups').on('submit', function(e) {
        e.preventDefault();
        searchGroups(1);
    });
    
    // × ×™×§×•×™ ×—×™×¤×•×©
    $('#clear-search-groups').on('click', function() {
        $('#search-form-groups')[0].reset();
        $('#results-container-groups, #no-results-groups').hide();
    });
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×™×•××Ÿ
    $(document).on('click', '.toggle-calendar-group', function() {
        const groupId = $(this).data('id');
        const currentStatus = parseInt($(this).data('status'));
        toggleGroupCalendarStatus(groupId, currentStatus);
    });
    
    // ×‘×—×™×¨×ª ×”×›×œ ×œ×™×•××Ÿ
    $('#select-all-calendar-groups').on('click', function() {
        $('.toggle-calendar-group[data-status="0"]').each(function() {
            const groupId = $(this).data('id');
            toggleGroupCalendarStatus(groupId, 0);
        });
    });
    
    // ×‘×™×˜×•×œ ×‘×—×™×¨×ª ×”×›×œ
    $('#deselect-all-calendar-groups').on('click', function() {
        $('.toggle-calendar-group[data-status="1"]').each(function() {
            const groupId = $(this).data('id');
            toggleGroupCalendarStatus(groupId, 1);
        });
    });
    
    // ×—×™×¤×•×© ××•×˜×•××˜×™ ×‘×”×§×œ×“×”
    $('#search-term-groups').on('input', function() {
        clearTimeout(window.searchTimerGroups);
        window.searchTimerGroups = setTimeout(function() {
            if ($('#search-term-groups').val().length >= 2) {
                searchGroups(1);
            }
        }, 500);
    });
    
    // ×¢×¨×™×›×ª ×©× ×—×‘×¨×” ×œ×§×‘×•×¦×•×ª - inline editing
    $(document).on('click', '.company-name-editable-group', function() {
        const $span = $(this);
        const groupId = $span.data('id');
        const currentValue = $span.text() === '×œ×—×¥ ×œ×”×’×“×¨×”' ? '' : $span.text();
        
        const $input = $('<input type="text" class="form-control form-control-sm" style="max-width: 200px;">');
        $input.val(currentValue);
        
        $span.replaceWith($input);
        $input.focus();
        
        // ×©××™×¨×” ×‘-Enter ××• blur
        $input.on('blur keypress', function(e) {
            if (e.type === 'blur' || e.which === 13) {
                const newValue = $input.val().trim();
                
                // ×©××™×¨×” ×œ×©×¨×ª
                $.ajax({
                    url: `/api/update/group/${groupId}/company`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ company_name: newValue }),
                    success: function(response) {
                        const $newSpan = $('<span class="company-name-editable-group" data-id="' + groupId + '" data-type="group" style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;" title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×”×—×‘×¨×”">' + (newValue || '×œ×—×¥ ×œ×”×’×“×¨×”') + '</span>');
                        $input.replaceWith($newSpan);
                        showAlert('×©× ×”×—×‘×¨×” ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
                    },
                    error: function() {
                        const $newSpan = $('<span class="company-name-editable-group" data-id="' + groupId + '" data-type="group" style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;" title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×”×—×‘×¨×”">' + currentValue + '</span>');
                        $input.replaceWith($newSpan);
                        showAlert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×©× ×”×—×‘×¨×”', 'error');
                    }
                });
                
                e.preventDefault();
            }
        });
    });
    
    // ×—×™×¤×•×© ×¨××©×•× ×™ - ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ ×›×œ ×”×§×‘×•×¦×•×ª
    $(document).ready(function() {
        // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
        $('#loading-groups').show();
        $('#results-container-groups, #no-results-groups').hide();
        
        // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ××™×“
        searchGroups(1);
    });
    
    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª × ×•×¡×¤×ª - ×œ××§×¨×” ×©×”×¨××©×•× ×” ×œ× ×¢×‘×“×”
    setTimeout(function() {
        if ($('#results-tbody-groups').children().length === 0) {
            console.log('×˜×¢×™× ×” ×¨××©×•× ×™×ª × ×•×¡×¤×ª...');
            searchGroups(1);
        }
    }, 1000);
    
    // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¡×™× ×›×¨×•×Ÿ (×–×”×” ×œ×× ×©×™ ×§×©×¨)
    let currentSyncId = null;
    let syncCheckInterval = null;
    let isMinimized = false;
    
    // ×©××™×¨×ª ×˜×•×•×— ×ª××¨×™×›×™× ×‘-localStorage
    function saveDateRange(startDate, endDate) {
        localStorage.setItem('lastSyncRange', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    }
    
    // ×˜×¢×™× ×ª ×˜×•×•×— ×ª××¨×™×›×™× ×©××•×¨
    function loadDateRange() {
        const saved = localStorage.getItem('lastSyncRange');
        if (saved) {
            try {
                const range = JSON.parse(saved);
                $('#sync-start-date').val(range.startDate);
                $('#sync-end-date').val(range.endDate);
            } catch (e) {
                console.log('×©×’×™××” ×‘×˜×¢×™× ×ª ×˜×•×•×— ×©××•×¨:', e);
            }
        } else {
            // ×‘×¨×™×¨×ª ××—×“×œ: 1 ×œ×—×•×“×© ×”×§×•×“× ×¢×“ ×”×™×•×
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            $('#sync-start-date').val(lastMonth.toISOString().split('T')[0]);
            $('#sync-end-date').val(today.toISOString().split('T')[0]);
        }
    }
    
    // ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×¡×™× ×›×¨×•×Ÿ
    $(document).on('click', '.sync-now', function() {
        const itemId = $(this).data('id');
        const itemType = $(this).data('type');
        
        $('#sync-item-id').val(itemId);
        $('#sync-item-type').val(itemType);
        
        // ×˜×¢×™× ×ª ×˜×•×•×— ×©××•×¨
        loadDateRange();
        
        // ×”×¦×’×ª ×”×¤×•×¤××¤
        $('#syncModal').modal('show');
    });
    
    // ××™×©×•×¨ ×¡×™× ×›×¨×•×Ÿ
    $('#confirm-sync').on('click', function() {
        const itemId = $('#sync-item-id').val();
        const itemType = $('#sync-item-type').val();
        const startDate = $('#sync-start-date').val();
        const endDate = $('#sync-end-date').val();
        
        if (!startDate || !endDate) {
            showAlert('× × ×œ×‘×—×•×¨ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×', 'error');
            return;
        }
        
        // ×©××™×¨×ª ×”×˜×•×•×—
        saveDateRange(startDate, endDate);
        
        // ×¡×’×™×¨×ª ×¤×•×¤××¤ ×‘×—×™×¨×”
        $('#syncModal').modal('hide');
        
        // ×”×¦×’×ª ×¤×•×¤××¤ ×”×ª×§×“××•×ª
        $('#progressModal').modal('show');
        
        // ×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ
        startSync(itemId, itemType, startDate, endDate);
    });
    
    // ×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ
    function startSync(itemId, itemType, startDate, endDate) {
        const url = itemType === 'contact' ? 
            `/api/sync/contact/${itemId}` : 
            `/api/sync/group/${itemId}`;
        
        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×¡× ×›×¨×•×Ÿ
        const syncButton = $(`.sync-now[data-id="${itemId}"]`);
        syncButton.prop('disabled', true);
        syncButton.html('<i class="fas fa-spinner fa-spin me-1"></i>××¡× ×›×¨×Ÿ...');
        syncButton.removeClass('btn-primary').addClass('btn-warning');
        
        $.ajax({
            url: url,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            }),
            success: function(response) {
                if (response.success) {
                    currentSyncId = response.sync_id;
                    $('#progress-text').text('×¡×™× ×›×¨×•×Ÿ ×”×•×ª×—×œ ×‘×”×¦×œ×—×”...');
                    startProgressCheck();
                } else {
                    showAlert('×©×’×™××” ×‘×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ: ' + response.error, 'error');
                    $('#progressModal').modal('hide');
                    resetSyncButton(syncButton);
                }
            },
            error: function() {
                showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
                $('#progressModal').modal('hide');
                resetSyncButton(syncButton);
            }
        });
    }
    
    // ××™×¤×•×¡ ×›×¤×ª×•×¨ ×¡× ×›×¨×•×Ÿ
    function resetSyncButton(button) {
        button.prop('disabled', false);
        button.html('<i class="fas fa-sync me-1"></i>×¡× ×›×¨×Ÿ ×¢×›×©×™×•');
        button.removeClass('btn-warning').addClass('btn-primary');
    }
    
    // ×‘×“×™×§×ª ×”×ª×§×“××•×ª ×¡×™× ×›×¨×•×Ÿ
    function startProgressCheck() {
        if (syncCheckInterval) {
            clearInterval(syncCheckInterval);
        }
        
        syncCheckInterval = setInterval(function() {
            if (!currentSyncId) return;
            
            $.get(`/api/sync/status/${currentSyncId}`)
                .done(function(status) {
                    if (status.status === 'completed') {
                        clearInterval(syncCheckInterval);
                        handleSyncComplete(status.result);
                    } else if (status.status === 'error') {
                        clearInterval(syncCheckInterval);
                        handleSyncError(status.error);
                    } else if (status.status === 'running') {
                        updateProgress(status);
                    }
                })
                .fail(function() {
                    clearInterval(syncCheckInterval);
                    handleSyncError('×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡');
                });
        }, 2000); // ×‘×“×™×§×” ×›×œ 2 ×©× ×™×•×ª
    }
    
    // ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª
    function updateProgress(status) {
        $('#progress-text').text('××¡× ×›×¨×Ÿ ×”×•×“×¢×•×ª...');
        $('#progress-details').html(`
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                ×”×ª×—×™×œ ×‘-${new Date(status.started_at).toLocaleString('he-IL')}
            </small>
        `);
    }
    
    // ×”×©×œ××ª ×¡×™× ×›×¨×•×Ÿ
    function handleSyncComplete(result) {
        $('#progressModal').modal('hide');
        
        if (result.success) {
            const message = `×¡×™× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!<br>
                           ğŸ“± ×”×•×“×¢×•×ª ×©× ××¦××•: ${result.messages_found}<br>
                           ğŸ’¾ ×”×•×“×¢×•×ª ×©× ×©××¨×•: ${result.messages_saved}<br>
                           ğŸ“… ××™×¨×•×¢×™× ×©× ×•×¦×¨×•: ${result.events_created}`;
            showAlert(message, 'success');
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×××©×§
            updateSyncStatus(result.contact_id || result.group_id, result);
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
            updateStats();
            
            // ×¨×¢× ×•×Ÿ ×¨×©×™××”
            searchGroups(currentPageGroups);
        } else {
            showAlert('×¡×™× ×›×¨×•×Ÿ × ×›×©×œ: ' + result.error, 'error');
        }
        
        currentSyncId = null;
    }
    
    // ×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ
    function handleSyncError(error) {
        $('#progressModal').modal('hide');
        showAlert('×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ: ' + error, 'error');
        currentSyncId = null;
    }
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×‘×××©×§
    function updateSyncStatus(itemId, result) {
        const statusDiv = $(`#sync-status-${itemId}`);
        const lastSyncDiv = $(`#last-sync-${itemId}`);
        
        if (statusDiv.length) {
            statusDiv.html(`
                <small class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    ×”×•×©×œ×: ${result.messages_saved} ×”×•×“×¢×•×ª, ${result.events_created} ××™×¨×•×¢×™×
                </small>
            `).show();
        }
        
        // ×¢×“×›×•×Ÿ ×¢××•×“×ª "×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ"
        if (lastSyncDiv.length) {
            const now = new Date().toLocaleString('he-IL');
            lastSyncDiv.html(`
                <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>
                    ${now}
                </span>
                <br>
                <small class="text-muted">
                    ${result.messages_saved} ×”×•×“×¢×•×ª, ${result.events_created} ××™×¨×•×¢×™×
                </small>
            `);
        }
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×§×™×™×
    function loadSyncStatus(itemId) {
        $.get(`/api/sync/status/item/${itemId}`)
            .done(function(status) {
                // Escape special characters in ID for jQuery selector
                const escapedId = itemId.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&");
                const lastSyncDiv = $(`#last-sync-${escapedId}`);
                const statusDiv = $(`#sync-status-${escapedId}`);
                
                if (status.last_sync) {
                    const lastSync = new Date(status.last_sync).toLocaleString('he-IL');
                    const icon = status.success ? 'check-circle text-success' : 'times-circle text-danger';
                    const badgeClass = status.success ? 'bg-success' : 'bg-danger';
                    
                    // ×¢×“×›×•×Ÿ ×¢××•×“×ª "×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ"
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge ${badgeClass}">
                                <i class="fas fa-${status.success ? 'check' : 'times'} me-1"></i>
                                ${lastSync}
                            </span>
                            <br>
                            <small class="text-muted">
                                ${status.messages_count} ×”×•×“×¢×•×ª, ${status.events_count} ××™×¨×•×¢×™×
                            </small>
                        `);
                    }
                    
                    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ (×× ×§×™×™×)
                    if (statusDiv.length) {
                        statusDiv.html(`
                            <small class="${status.success ? 'text-success' : 'text-danger'}">
                                <i class="fas fa-${icon} me-1"></i>
                                ×”×•×©×œ×: ${status.messages_count} ×”×•×“×¢×•×ª, ${status.events_count} ××™×¨×•×¢×™×
                            </small>
                        `).show();
                    }
                } else {
                    // ×× ×œ× ×¡×•× ×›×¨×Ÿ ××¢×•×œ×
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge bg-secondary">
                                <i class="fas fa-clock me-1"></i>
                                ×œ× ×¡×•× ×›×¨×Ÿ
                            </span>
                        `);
                    }
                }
            })
            .fail(function() {
                const lastSyncDiv = $(`#last-sync-${itemId}`);
                if (lastSyncDiv.length) {
                    lastSyncDiv.html(`
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ×©×’×™××”
                        </span>
                    `);
                }
            });
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×œ×›×œ ×”×¤×¨×™×˜×™×
    function loadAllSyncStatus() {
        $('.sync-now').each(function() {
            const itemId = $(this).data('id');
            loadSyncStatus(itemId);
        });
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ××—×¨×™ ×—×™×¤×•×©
    setTimeout(loadAllSyncStatus, 1000);
    
    // ××—×™×§×ª ×§×‘×•×¦×”
    $(document).on('click', '.delete-group', function() {
        const groupId = $(this).data('id');
        const groupName = $(this).data('name');
        
        if (confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×•×¦×” "${groupName}"?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×”×§×‘×•×¦×” ××”×•×•××˜×¡××¤ ×©×œ×š ×•××”××¡×“ ×”× ×ª×•× ×™× ×•×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ ××•×ª×”.`)) {
            deleteGroup(groupId);
        }
    });
    
    // ×¤×•× ×§×¦×™×” ×œ××—×™×§×ª ×§×‘×•×¦×”
    function deleteGroup(groupId) {
        // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
        showAlert('××‘×¦×¢ ××—×™×§×ª ×§×‘×•×¦×” ××”×•×•××˜×¡××¤... ×–×” ×™×›×•×œ ×œ×§×—×ª ×›××” ×“×§×•×ª', 'info');
        
        $.ajax({
            url: `/api/delete/group/${groupId}`,
            method: 'DELETE',
            timeout: 120000, // 2 ×“×§×•×ª timeout
            success: function(response) {
                if (response.success) {
                    // ×”×¡×¨×ª ×”×©×•×¨×” ××”×˜×‘×œ×”
                    $(`tr[data-group-id="${groupId}"]`).fadeOut(300, function() {
                        $(this).remove();
                    });
                    
                    // ×”×•×“×¢×ª ×”×¦×œ×—×” ××¤×•×¨×˜×ª
                    let successMessage = '×”×§×‘×•×¦×” × ××—×§×” ×‘×”×¦×œ×—×”!';
                    if (response.whatsapp_deletion) {
                        const details = response.whatsapp_deletion;
                        if (details.participants_removed > 0) {
                            successMessage += `\n×”×•×¡×¨×• ${details.participants_removed} ××©×ª×ª×¤×™× ××”×§×‘×•×¦×”.`;
                        }
                        if (details.group_left) {
                            successMessage += '\n×¢×–×‘×ª ××ª ×”×§×‘×•×¦×” ×‘×”×¦×œ×—×”.';
                        }
                    }
                    if (response.api_used) {
                        const apiName = response.api_used === 'green_api' ? 'Green API' : 'Evolution API';
                        successMessage += `\n×”××—×™×§×” ×‘×•×¦×¢×” ×‘×××¦×¢×•×ª ${apiName}.`;
                    }
                    showAlert(successMessage, 'success');
                    
                    // ×¨×¢× ×•×Ÿ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª
                    loadStats();
                } else {
                    showAlert('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×•×¦×”: ' + (response.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'), 'danger');
                }
            },
            error: function(xhr) {
                let errorMessage = '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 0) {
                    errorMessage = '×©×’×™××ª timeout - ×”×¤×¢×•×œ×” ×œ×•×§×—×ª ×™×•×ª×¨ ××“×™ ×–××Ÿ';
                }
                showAlert('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×•×¦×”: ' + errorMessage, 'danger');
            }
        });
    }
    
    // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¦××¦×•× ×—×œ×•×Ÿ ×¡×™× ×›×¨×•×Ÿ
    $('#minimize-sync').on('click', function() {
        $('#progressModal').modal('hide');
        $('#minimized-sync').show();
        isMinimized = true;
    });
    
    $('#restore-sync').on('click', function() {
        $('#minimized-sync').hide();
        $('#progressModal').modal('show');
        isMinimized = false;
    });
    
    // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×œ×•×’
    function addSyncLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('he-IL');
        const logClass = type === 'error' ? 'text-danger' : 
                        type === 'success' ? 'text-success' : 
                        type === 'warning' ? 'text-warning' : 'text-light';
        
        const logEntry = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
        
        // ×”×•×¡×¤×” ×œ×—×œ×•×Ÿ ×”×¨××©×™
        $('#sync-logs').append(logEntry);
        $('#sync-logs').scrollTop($('#sync-logs')[0].scrollHeight);
        
        // ×”×•×¡×¤×” ×œ×—×œ×•×Ÿ ×”××•×§×˜×Ÿ
        if (isMinimized) {
            $('#minimized-progress-text').text(message);
        }
    }
    
    // ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×•×ª ×”×¡×™× ×›×¨×•×Ÿ ×¢× ×œ×•×’×™×
    const originalStartSync = startSync;
    startSync = function(itemId, itemType, startDate, endDate) {
        addSyncLog(`××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ ${itemType}: ${itemId}`, 'info');
        addSyncLog(`×ª×§×•×¤×”: ${startDate} - ${endDate}`, 'info');
        return originalStartSync(itemId, itemType, startDate, endDate);
    };
    
    const originalUpdateProgress = updateProgress;
    updateProgress = function(status) {
        addSyncLog('××¡× ×›×¨×Ÿ ×”×•×“×¢×•×ª...', 'info');
        return originalUpdateProgress(status);
    };
    
    const originalHandleSyncComplete = handleSyncComplete;
    handleSyncComplete = function(result) {
        if (result.success) {
            addSyncLog(`âœ… ×¡×™× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!`, 'success');
            addSyncLog(`ğŸ“± ×”×•×“×¢×•×ª ×©× ××¦××•: ${result.messages_found}`, 'success');
            addSyncLog(`ğŸ’¾ ×”×•×“×¢×•×ª ×©× ×©××¨×•: ${result.messages_saved}`, 'success');
            addSyncLog(`ğŸ“… ××™×¨×•×¢×™× ×©× ×•×¦×¨×•: ${result.events_created}`, 'success');
        } else {
            addSyncLog(`âŒ ×¡×™× ×›×¨×•×Ÿ × ×›×©×œ: ${result.error}`, 'error');
        }
        
        // ××™×¤×•×¡ ×›×œ ×›×¤×ª×•×¨×™ ×”×¡× ×›×¨×•×Ÿ
        $('.sync-now').each(function() {
            resetSyncButton($(this));
        });
        
        return originalHandleSyncComplete(result);
    };
    
    const originalHandleSyncError = handleSyncError;
    handleSyncError = function(error) {
        addSyncLog(`âŒ ×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ: ${error}`, 'error');
        
        // ××™×¤×•×¡ ×›×œ ×›×¤×ª×•×¨×™ ×”×¡× ×›×¨×•×Ÿ
        $('.sync-now').each(function() {
            resetSyncButton($(this));
        });
        
        return originalHandleSyncError(error);
    };
});

// ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×œ×•×’×™×
let autoRefreshInterval = null;
let isAutoRefreshActive = false;
let currentLogLevel = 'all';

// ×˜×¢×™× ×ª ×œ×•×’×™×
function loadLogs() {
    $.ajax({
        url: '/api/logs',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayLogs(response.logs);
                updateLogCount(response.logs.length);
            } else {
                showAlert('×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×•×’×™×: ' + (response.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'), 'danger');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || '×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª';
            showAlert('×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×•×’×™×: ' + error, 'danger');
        }
    });
}

// ×”×¦×’×ª ×œ×•×’×™×
function displayLogs(logs) {
    const container = $('#logs-container');
    container.empty();
    
    if (logs.length === 0) {
        container.html('<div class="text-center text-muted p-4">××™×Ÿ ×œ×•×’×™× ×œ×”×¦×’×”</div>');
        return;
    }
    
    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¨××”
    let filteredLogs = logs;
    if (currentLogLevel !== 'all') {
        filteredLogs = logs.filter(log => log.level === currentLogLevel);
    }
    
    // ×”×¦×’×ª ×”×œ×•×’×™× (×”×›×™ ×—×“×©×™× ×œ××¢×œ×”)
    filteredLogs.reverse().forEach(log => {
        const logEntry = createLogEntry(log);
        container.append(logEntry);
    });
    
    // ×’×œ×™×œ×” ×œ××˜×”
    container.scrollTop(container[0].scrollHeight);
}

// ×™×¦×™×¨×ª ××œ×× ×˜ ×œ×•×’
function createLogEntry(log) {
    const timestamp = new Date(log.timestamp).toLocaleString('he-IL');
    const levelClass = log.level || 'INFO';
    
    return $(`
        <div class="log-entry ${levelClass}">
            <span class="log-timestamp">${timestamp}</span>
            <span class="log-level">[${levelClass}]</span>
            <span class="log-message">${log.message}</span>
        </div>
    `);
}

// ×¢×“×›×•×Ÿ ××•× ×” ×”×œ×•×’×™×
function updateLogCount(count) {
    $('#log-count').text(`${count} ×”×•×“×¢×•×ª`);
}

// ×¨×¢× ×•×Ÿ ×œ×•×’×™×
$('#refresh-logs').on('click', function() {
    loadLogs();
});

// × ×™×§×•×™ ××¡×š ×”×œ×•×’×™×
$('#clear-logs').on('click', function() {
    $('#logs-container').empty();
    updateLogCount(0);
});

// ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
$('#auto-refresh-toggle').on('click', function() {
    if (isAutoRefreshActive) {
        // ×¢×¦×™×¨×ª ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
        clearInterval(autoRefreshInterval);
        isAutoRefreshActive = false;
        $(this).removeClass('auto-refresh-active');
        $(this).html('<i class="fas fa-play me-1"></i>×¨×¢× ×•×Ÿ ××•×˜×•××˜×™');
    } else {
        // ×”×ª×—×œ×ª ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
        autoRefreshInterval = setInterval(loadLogs, 5000); // ×›×œ 5 ×©× ×™×•×ª
        isAutoRefreshActive = true;
        $(this).addClass('auto-refresh-active');
        $(this).html('<i class="fas fa-pause me-1"></i>×¢×¦×•×¨ ×¨×¢× ×•×Ÿ');
    }
});

// ×¡×™× ×•×Ÿ ×œ×¤×™ ×¨××ª ×œ×•×’
$('#log-level-filter').on('change', function() {
    currentLogLevel = $(this).val();
    loadLogs();
});

// ×˜×¢×™× ×ª ×œ×•×’×™× ×¨××©×•× ×™×ª
$(document).ready(function() {
    // ×˜×¢×™× ×ª ×œ×•×’×™× ×¨×§ ×›×©×”×˜××‘ ×©×œ ×”×œ×•×’×™× × ×¤×ª×—
    $('#logs-tab').on('shown.bs.tab', function() {
        loadLogs();
    });
});
</script>
{% endblock %}



