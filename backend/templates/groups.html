{% extends "base.html" %}

{% block title %}ניהול קבוצות{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-users-cog me-2"></i>
            ניהול קבוצות
        </h2>
        <p class="text-muted">חפש וסנן את הקבוצות שלך, ובחר אילו קבוצות יכנסו ליומן TimeBro</p>
    </div>
</div>

<!-- טאבים -->
<ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="true">
            <i class="fas fa-users me-1"></i>קבוצות
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">
            <i class="fas fa-file-alt me-1"></i>לוגים
        </button>
    </li>
</ul>

<div class="tab-content" id="mainTabContent">
    <!-- טאב קבוצות -->
    <div class="tab-pane fade show active" id="groups" role="tabpanel" aria-labelledby="groups-tab">

<!-- טופס חיפוש -->
<div class="search-form">
    <form id="search-form-groups">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="search-term-groups" class="form-label">
                    <i class="fas fa-search me-1"></i>חיפוש לפי שם קבוצה
                </label>
                <input type="text" class="form-control" id="search-term-groups" placeholder="הזן שם קבוצה לחיפוש...">
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">
                    <i class="fas fa-filter me-1"></i>פילטרים
                </label>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="calendar-only-groups">
                        <label class="form-check-label" for="calendar-only-groups">
                            <i class="fas fa-calendar-check me-1"></i>מסומנות ליומן בלבד
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="date-from-groups" class="form-label">
                    <i class="fas fa-calendar me-1"></i>מתאריך
                </label>
                <input type="date" class="form-control" id="date-from-groups">
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="date-to-groups" class="form-label">
                    <i class="fas fa-calendar me-1"></i>עד תאריך
                </label>
                <input type="date" class="form-control" id="date-to-groups">
            </div>
            
            <div class="col-md-6 mb-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i>חפש
                    </button>
                    <button type="button" class="btn btn-secondary" id="clear-search-groups">
                        <i class="fas fa-times me-1"></i>נקה
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Loading -->
<div class="loading" id="loading-groups">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">טוען...</span>
    </div>
    <p class="mt-2">טוען קבוצות...</p>
    <p class="text-muted small">מציג את כל הקבוצות שלך</p>
</div>

<!-- תוצאות -->
<div id="results-container-groups" style="display: block;">
    <!-- כותרת תוצאות -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="results-title-groups">תוצאות חיפוש</h4>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-success btn-sm" id="select-all-calendar-groups">
                <i class="fas fa-check-double me-1"></i>בחר הכל ליומן
            </button>
            <button type="button" class="btn btn-warning btn-sm" id="deselect-all-calendar-groups">
                <i class="fas fa-times me-1"></i>בטל בחירת הכל
            </button>
        </div>
    </div>

    <!-- טבלת תוצאות -->
    <div class="results-table">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>שם קבוצה</th>
                        <th>תיאור</th>
                        <th>שם חברה</th>
                        <th>משתתפים</th>
                        <th>בעלים</th>
                        <th>נוצר</th>
                        <th>נוסף למערכת</th>
                        <th>כלול ביומן</th>
                        <th>סנכרון אחרון</th>
                        <th>סנכרון</th>
                    </tr>
                </thead>
                <tbody id="results-tbody-groups">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <nav>
            <ul class="pagination justify-content-center" id="pagination-groups">
            </ul>
        </nav>
        <p class="text-muted" id="results-info-groups"></p>
    </div>
</div>

<!-- הודעה אם אין תוצאות -->
<div id="no-results-groups" style="display: none;">
    <div class="alert alert-info text-center">
        <i class="fas fa-search fa-2x mb-3"></i>
        <h5>לא נמצאו תוצאות</h5>
        <p>נסה לשנות את קריטריוני החיפוש</p>
    </div>
</div>

<!-- פופאפ בחירת תקופה -->
<div class="modal fade" id="syncModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync me-2"></i>בחירת תקופת סינכרון
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sync-form">
                    <input type="hidden" id="sync-item-id">
                    <input type="hidden" id="sync-item-type">
                    
                    <div class="mb-3">
                        <label for="sync-start-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>מתאריך
                        </label>
                        <input type="date" class="form-control" id="sync-start-date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sync-end-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>עד תאריך
                        </label>
                        <input type="date" class="form-control" id="sync-end-date" required>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>מידע:</strong> הסינכרון יכלול הודעות טקסט בלבד ויוסיף אירועים ליומן Google.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                <button type="button" class="btn btn-primary" id="confirm-sync">
                    <i class="fas fa-sync me-1"></i>התחל סינכרון
                </button>
            </div>
        </div>
    </div>
</div>

<!-- פופאפ התקדמות סינכרון -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync fa-spin me-2"></i>מסנכרן...
                </h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="minimize-sync">
                    <i class="fas fa-window-minimize"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progress-text">מתחיל סינכרון...</div>
                <div id="progress-details" class="mt-2"></div>
                
                <!-- לוגים מפורטים -->
                <div class="mt-3">
                    <h6><i class="fas fa-list me-2"></i>לוג פעילות:</h6>
                    <div id="sync-logs" class="bg-dark text-light p-2 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div class="text-success">[מתחיל] מערכת סינכרון הופעלה...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-sync-modal" style="display: none;">
                    <i class="fas fa-times me-1"></i>סגור
                </button>
            </div>
        </div>
    </div>
</div>

<!-- חלון מוקטן לסינכרון -->
<div id="minimized-sync" class="position-fixed bottom-0 end-0 p-3" style="display: none; z-index: 1050;">
    <div class="card shadow" style="width: 300px;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-sync fa-spin me-2"></i>מסנכרן...
            </h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="restore-sync">
                <i class="fas fa-window-restore"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div id="minimized-progress-text" class="small">מתחיל סינכרון...</div>
        </div>
    </div>
</div>

    <!-- טאב לוגים -->
    <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
        <div class="row">
            <div class="col-12">
                <h3>
                    <i class="fas fa-file-alt me-2"></i>
                    לוגים של המערכת
                </h3>
                <p class="text-muted">צפייה בלוגים של פעולות המערכת בזמן אמת</p>
            </div>
        </div>

        <!-- בקרות לוגים -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" id="refresh-logs">
                        <i class="fas fa-sync-alt me-1"></i>רענן לוגים
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="clear-logs">
                        <i class="fas fa-trash me-1"></i>נקה מסך
                    </button>
                    <button type="button" class="btn btn-outline-info" id="auto-refresh-toggle">
                        <i class="fas fa-play me-1"></i>רענון אוטומטי
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <select class="form-select" id="log-level-filter">
                        <option value="all">כל הרמות</option>
                        <option value="INFO">מידע</option>
                        <option value="WARNING">אזהרה</option>
                        <option value="ERROR">שגיאה</option>
                        <option value="DEBUG">דיבוג</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- אזור הלוגים -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-1"></i>
                            לוגים
                        </h5>
                        <small class="text-muted" id="log-count">0 הודעות</small>
                    </div>
                    <div class="card-body p-0">
                        <div id="logs-container" class="logs-container">
                            <div class="text-center text-muted p-4">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                טוען לוגים...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.logs-container {
    height: 500px;
    overflow-y: auto;
    background-color: #1e1e1e;
    color: #ffffff;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    padding: 15px;
    border-radius: 0 0 0.375rem 0.375rem;
}

.log-entry {
    margin-bottom: 8px;
    padding: 5px 8px;
    border-radius: 3px;
    border-left: 3px solid transparent;
    word-wrap: break-word;
    white-space: pre-wrap;
}

.log-entry.INFO {
    border-left-color: #17a2b8;
    background-color: rgba(23, 162, 184, 0.1);
}

.log-entry.WARNING {
    border-left-color: #ffc107;
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.log-entry.ERROR {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
    color: #ff6b6b;
}

.log-entry.DEBUG {
    border-left-color: #6c757d;
    background-color: rgba(108, 117, 125, 0.1);
    color: #adb5bd;
}

.log-timestamp {
    color: #6c757d;
    font-size: 11px;
    margin-right: 10px;
}

.log-level {
    font-weight: bold;
    margin-right: 10px;
    min-width: 60px;
    display: inline-block;
}

.log-message {
    color: #ffffff;
}

.auto-refresh-active {
    background-color: #28a745 !important;
    color: white !important;
}

.auto-refresh-active i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.logs-container::-webkit-scrollbar {
    width: 8px;
}

.logs-container::-webkit-scrollbar-track {
    background: #2d2d2d;
}

.logs-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.logs-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentPageGroups = 1;
let currentFiltersGroups = {};

// פורמט תאריך - מוגדר גלובלית
function formatDate(dateString) {
    if (!dateString) return 'לא ידוע';
    
    // טיפול בתאריכים שונים
    let date;
    if (typeof dateString === 'string') {
        // אם זה timestamp
        if (/^\d+$/.test(dateString)) {
            date = new Date(parseInt(dateString) * 1000);
        } else {
            date = new Date(dateString);
        }
    } else {
        date = new Date(dateString);
    }
    
    // בדיקה אם התאריך תקין
    if (isNaN(date.getTime())) {
        return 'לא ידוע';
    }
    
    return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
}

// חיפוש קבוצות
function searchGroups(page = 1) {
    currentPageGroups = page;
    
    // איסוף פרמטרי חיפוש
    const params = {
        search: $('#search-term-groups').val(),
        date_from: $('#date-from-groups').val(),
        date_to: $('#date-to-groups').val(),
        calendar_only: $('#calendar-only-groups').is(':checked'),
        page: page,
        per_page: 50
    };
    
    currentFiltersGroups = params;
    
    $('#loading-groups').show();
    $('#results-container-groups, #no-results-groups').hide();
    
    $.get('/api/search/groups', params)
        .done(function(data) {
            $('#loading-groups').hide();
            
            if (data.error) {
                showAlert('שגיאה בחיפוש: ' + data.error, 'error');
                return;
            }
            
            if (data.groups && data.groups.length > 0) {
                displayGroupsResults(data);
            } else {
                $('#no-results-groups').show();
            }
        })
        .fail(function() {
            $('#loading-groups').hide();
            showAlert('שגיאה בתקשורת עם השרת', 'error');
        });
}

// הצגת תוצאות קבוצות
function displayGroupsResults(data) {
    const tbody = $('#results-tbody-groups');
    tbody.empty();
    
    data.groups.forEach(function(group) {
        const row = createGroupRow(group);
        tbody.append(row);
    });
    
    // עדכון מידע תוצאות
    const start = (data.page - 1) * data.per_page + 1;
    const end = Math.min(start + data.groups.length - 1, data.total);
    $('#results-info-groups').text(`מציג ${start}-${end} מתוך ${data.total.toLocaleString()} תוצאות`);
    $('#results-title-groups').text(`נמצאו ${data.total.toLocaleString()} קבוצות`);
    
    // עדכון pagination
    updateGroupsPagination(data);
    
    $('#results-container-groups').show();
}

// יצירת שורה בטבלת קבוצות
function createGroupRow(group) {
    const calendarButton = group.include_in_timebro ? 
        `<button class="btn btn-calendar-yes btn-sm toggle-calendar-group" data-id="${group.group_id}" data-status="1">
            <i class="fas fa-calendar-check me-1"></i>כלול
        </button>` :
        `<button class="btn btn-calendar-no btn-sm toggle-calendar-group" data-id="${group.group_id}" data-status="0">
            <i class="fas fa-calendar-times me-1"></i>לא כלול
        </button>`;
    
    const description = group.description ? 
        (group.description.length > 50 ? group.description.substring(0, 50) + '...' : group.description) : 
        'ללא תיאור';
    
    return `
        <tr data-group-id="${group.group_id}">
            <td>
                <strong>${group.subject || 'ללא שם'}</strong>
            </td>
            <td>
                <span class="text-muted">${description}</span>
            </td>
            <td>
                <span class="company-name-editable-group" 
                      data-id="${group.group_id}" 
                      data-type="group"
                      style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;"
                      title="לחץ לעריכת שם החברה">
                    ${group.company_name || 'לחץ להגדרה'}
                </span>
            </td>
            <td>
                <span class="badge bg-info">${group.size || 0}</span>
            </td>
            <td>
                <small>${group.owner || 'לא ידוע'}</small>
            </td>
            <td>
                <small>${formatDate(group.created_at)}</small>
            </td>
            <td>
                <small>${formatDate(group.updated_at)}</small>
            </td>
            <td>
                ${calendarButton}
            </td>
            <td>
                <div class="last-sync" id="last-sync-${group.id}">
                    <small class="text-muted">טוען...</small>
                </div>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary btn-sm sync-now" data-id="${group.id}" data-type="group">
                        <i class="fas fa-sync me-1"></i>סנכרן עכשיו
                    </button>
                    <button class="btn btn-danger btn-sm delete-group" data-id="${group.id}" data-name="${group.name || 'קבוצה'}">
                        <i class="fas fa-trash me-1"></i>מחק
                    </button>
                </div>
                <div class="sync-status" id="sync-status-${group.id}" style="display: none;">
                    <small class="text-muted">מסנכרן...</small>
                </div>
            </td>
        </tr>
    `;
}

// עדכון pagination לקבוצות
function updateGroupsPagination(data) {
    const pagination = $('#pagination-groups');
    pagination.empty();
    
    if (data.total_pages <= 1) return;
    
    // כפתור הקודם
    if (data.page > 1) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchGroups(${data.page - 1})">הקודם</a>
            </li>
        `);
    }
    
    // מספרי עמודים
    const startPage = Math.max(1, data.page - 2);
    const endPage = Math.min(data.total_pages, data.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === data.page ? 'active' : '';
        pagination.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="searchGroups(${i})">${i}</a>
            </li>
        `);
    }
    
    // כפתור הבא
    if (data.page < data.total_pages) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchGroups(${data.page + 1})">הבא</a>
            </li>
        `);
    }
}

// עדכון סטטוס יומן לקבוצות
function toggleGroupCalendarStatus(groupId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    
    $.ajax({
        url: `/api/update/group/${groupId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ include_in_timebro: newStatus === 1 }),
        success: function(response) {
            if (response.error) {
                showAlert('שגיאה בעדכון: ' + response.error, 'error');
                return;
            }
            
            // עדכון הכפתור
            const button = $(`.toggle-calendar-group[data-id="${groupId}"]`);
            if (newStatus === 1) {
                button.removeClass('btn-calendar-no').addClass('btn-calendar-yes')
                      .attr('data-status', '1')
                      .html('<i class="fas fa-calendar-check me-1"></i>כלול');
            } else {
                button.removeClass('btn-calendar-yes').addClass('btn-calendar-no')
                      .attr('data-status', '0')
                      .html('<i class="fas fa-calendar-times me-1"></i>לא כלול');
            }
            
            updateStats();
            showAlert('הסטטוס עודכן בהצלחה');
        },
        error: function() {
            showAlert('שגיאה בתקשורת עם השרת', 'error');
        }
    });
}

// אירועים
$(document).ready(function() {
    // חיפוש בטופס
    $('#search-form-groups').on('submit', function(e) {
        e.preventDefault();
        searchGroups(1);
    });
    
    // ניקוי חיפוש
    $('#clear-search-groups').on('click', function() {
        $('#search-form-groups')[0].reset();
        $('#results-container-groups, #no-results-groups').hide();
    });
    
    // עדכון סטטוס יומן
    $(document).on('click', '.toggle-calendar-group', function() {
        const groupId = $(this).data('id');
        const currentStatus = parseInt($(this).data('status'));
        toggleGroupCalendarStatus(groupId, currentStatus);
    });
    
    // בחירת הכל ליומן
    $('#select-all-calendar-groups').on('click', function() {
        $('.toggle-calendar-group[data-status="0"]').each(function() {
            const groupId = $(this).data('id');
            toggleGroupCalendarStatus(groupId, 0);
        });
    });
    
    // ביטול בחירת הכל
    $('#deselect-all-calendar-groups').on('click', function() {
        $('.toggle-calendar-group[data-status="1"]').each(function() {
            const groupId = $(this).data('id');
            toggleGroupCalendarStatus(groupId, 1);
        });
    });
    
    // חיפוש אוטומטי בהקלדה
    $('#search-term-groups').on('input', function() {
        clearTimeout(window.searchTimerGroups);
        window.searchTimerGroups = setTimeout(function() {
            if ($('#search-term-groups').val().length >= 2) {
                searchGroups(1);
            }
        }, 500);
    });
    
    // עריכת שם חברה לקבוצות - inline editing
    $(document).on('click', '.company-name-editable-group', function() {
        const $span = $(this);
        const groupId = $span.data('id');
        const currentValue = $span.text() === 'לחץ להגדרה' ? '' : $span.text();
        
        const $input = $('<input type="text" class="form-control form-control-sm" style="max-width: 200px;">');
        $input.val(currentValue);
        
        $span.replaceWith($input);
        $input.focus();
        
        // שמירה ב-Enter או blur
        $input.on('blur keypress', function(e) {
            if (e.type === 'blur' || e.which === 13) {
                const newValue = $input.val().trim();
                
                // שמירה לשרת
                $.ajax({
                    url: `/api/update/group/${groupId}/company`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ company_name: newValue }),
                    success: function(response) {
                        const $newSpan = $('<span class="company-name-editable-group" data-id="' + groupId + '" data-type="group" style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;" title="לחץ לעריכת שם החברה">' + (newValue || 'לחץ להגדרה') + '</span>');
                        $input.replaceWith($newSpan);
                        showAlert('שם החברה עודכן בהצלחה');
                    },
                    error: function() {
                        const $newSpan = $('<span class="company-name-editable-group" data-id="' + groupId + '" data-type="group" style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;" title="לחץ לעריכת שם החברה">' + currentValue + '</span>');
                        $input.replaceWith($newSpan);
                        showAlert('שגיאה בעדכון שם החברה', 'error');
                    }
                });
                
                e.preventDefault();
            }
        });
    });
    
    // חיפוש ראשוני - טעינה אוטומטית של כל הקבוצות
    $(document).ready(function() {
        // הצגת הודעת טעינה
        $('#loading-groups').show();
        $('#results-container-groups, #no-results-groups').hide();
        
        // טעינה ראשונית מיד
        searchGroups(1);
    });
    
    // טעינה ראשונית נוספת - למקרה שהראשונה לא עבדה
    setTimeout(function() {
        if ($('#results-tbody-groups').children().length === 0) {
            console.log('טעינה ראשונית נוספת...');
            searchGroups(1);
        }
    }, 1000);
    
    // פונקציונליות סינכרון (זהה לאנשי קשר)
    let currentSyncId = null;
    let syncCheckInterval = null;
    let isMinimized = false;
    
    // שמירת טווח תאריכים ב-localStorage
    function saveDateRange(startDate, endDate) {
        localStorage.setItem('lastSyncRange', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    }
    
    // טעינת טווח תאריכים שמור
    function loadDateRange() {
        const saved = localStorage.getItem('lastSyncRange');
        if (saved) {
            try {
                const range = JSON.parse(saved);
                $('#sync-start-date').val(range.startDate);
                $('#sync-end-date').val(range.endDate);
            } catch (e) {
                console.log('שגיאה בטעינת טווח שמור:', e);
            }
        } else {
            // ברירת מחדל: 1 לחודש הקודם עד היום
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            $('#sync-start-date').val(lastMonth.toISOString().split('T')[0]);
            $('#sync-end-date').val(today.toISOString().split('T')[0]);
        }
    }
    
    // לחיצה על כפתור סינכרון
    $(document).on('click', '.sync-now', function() {
        const itemId = $(this).data('id');
        const itemType = $(this).data('type');
        
        $('#sync-item-id').val(itemId);
        $('#sync-item-type').val(itemType);
        
        // טעינת טווח שמור
        loadDateRange();
        
        // הצגת הפופאפ
        $('#syncModal').modal('show');
    });
    
    // אישור סינכרון
    $('#confirm-sync').on('click', function() {
        const itemId = $('#sync-item-id').val();
        const itemType = $('#sync-item-type').val();
        const startDate = $('#sync-start-date').val();
        const endDate = $('#sync-end-date').val();
        
        if (!startDate || !endDate) {
            showAlert('נא לבחור תאריכי התחלה וסיום', 'error');
            return;
        }
        
        // שמירת הטווח
        saveDateRange(startDate, endDate);
        
        // סגירת פופאפ בחירה
        $('#syncModal').modal('hide');
        
        // הצגת פופאפ התקדמות
        $('#progressModal').modal('show');
        
        // התחלת סינכרון
        startSync(itemId, itemType, startDate, endDate);
    });
    
    // התחלת סינכרון
    function startSync(itemId, itemType, startDate, endDate) {
        const url = itemType === 'contact' ? 
            `/api/sync/contact/${itemId}` : 
            `/api/sync/group/${itemId}`;
        
        // עדכון כפתור הסנכרון
        const syncButton = $(`.sync-now[data-id="${itemId}"]`);
        syncButton.prop('disabled', true);
        syncButton.html('<i class="fas fa-spinner fa-spin me-1"></i>מסנכרן...');
        syncButton.removeClass('btn-primary').addClass('btn-warning');
        
        $.ajax({
            url: url,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            }),
            success: function(response) {
                if (response.success) {
                    currentSyncId = response.sync_id;
                    $('#progress-text').text('סינכרון הותחל בהצלחה...');
                    startProgressCheck();
                } else {
                    showAlert('שגיאה בהתחלת סינכרון: ' + response.error, 'error');
                    $('#progressModal').modal('hide');
                    resetSyncButton(syncButton);
                }
            },
            error: function() {
                showAlert('שגיאה בתקשורת עם השרת', 'error');
                $('#progressModal').modal('hide');
                resetSyncButton(syncButton);
            }
        });
    }
    
    // איפוס כפתור סנכרון
    function resetSyncButton(button) {
        button.prop('disabled', false);
        button.html('<i class="fas fa-sync me-1"></i>סנכרן עכשיו');
        button.removeClass('btn-warning').addClass('btn-primary');
    }
    
    // בדיקת התקדמות סינכרון
    function startProgressCheck() {
        if (syncCheckInterval) {
            clearInterval(syncCheckInterval);
        }
        
        syncCheckInterval = setInterval(function() {
            if (!currentSyncId) return;
            
            $.get(`/api/sync/status/${currentSyncId}`)
                .done(function(status) {
                    if (status.status === 'completed') {
                        clearInterval(syncCheckInterval);
                        handleSyncComplete(status.result);
                    } else if (status.status === 'error') {
                        clearInterval(syncCheckInterval);
                        handleSyncError(status.error);
                    } else if (status.status === 'running') {
                        updateProgress(status);
                    }
                })
                .fail(function() {
                    clearInterval(syncCheckInterval);
                    handleSyncError('שגיאה בבדיקת סטטוס');
                });
        }, 2000); // בדיקה כל 2 שניות
    }
    
    // עדכון התקדמות
    function updateProgress(status) {
        $('#progress-text').text('מסנכרן הודעות...');
        $('#progress-details').html(`
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                התחיל ב-${new Date(status.started_at).toLocaleString('he-IL')}
            </small>
        `);
    }
    
    // השלמת סינכרון
    function handleSyncComplete(result) {
        $('#progressModal').modal('hide');
        
        if (result.success) {
            const message = `סינכרון הושלם בהצלחה!<br>
                           📱 הודעות שנמצאו: ${result.messages_found}<br>
                           💾 הודעות שנשמרו: ${result.messages_saved}<br>
                           📅 אירועים שנוצרו: ${result.events_created}`;
            showAlert(message, 'success');
            
            // עדכון סטטוס בממשק
            updateSyncStatus(result.contact_id || result.group_id, result);
            
            // עדכון סטטיסטיקות
            updateStats();
            
            // רענון רשימה
            searchGroups(currentPageGroups);
        } else {
            showAlert('סינכרון נכשל: ' + result.error, 'error');
        }
        
        currentSyncId = null;
    }
    
    // שגיאה בסינכרון
    function handleSyncError(error) {
        $('#progressModal').modal('hide');
        showAlert('שגיאה בסינכרון: ' + error, 'error');
        currentSyncId = null;
    }
    
    // עדכון סטטוס סינכרון בממשק
    function updateSyncStatus(itemId, result) {
        const statusDiv = $(`#sync-status-${itemId}`);
        const lastSyncDiv = $(`#last-sync-${itemId}`);
        
        if (statusDiv.length) {
            statusDiv.html(`
                <small class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    הושלם: ${result.messages_saved} הודעות, ${result.events_created} אירועים
                </small>
            `).show();
        }
        
        // עדכון עמודת "סנכרון אחרון"
        if (lastSyncDiv.length) {
            const now = new Date().toLocaleString('he-IL');
            lastSyncDiv.html(`
                <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>
                    ${now}
                </span>
                <br>
                <small class="text-muted">
                    ${result.messages_saved} הודעות, ${result.events_created} אירועים
                </small>
            `);
        }
    }
    
    // טעינת סטטוס סינכרון קיים
    function loadSyncStatus(itemId) {
        $.get(`/api/sync/status/item/${itemId}`)
            .done(function(status) {
                // Escape special characters in ID for jQuery selector
                const escapedId = itemId.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&");
                const lastSyncDiv = $(`#last-sync-${escapedId}`);
                const statusDiv = $(`#sync-status-${escapedId}`);
                
                if (status.last_sync) {
                    const lastSync = new Date(status.last_sync).toLocaleString('he-IL');
                    const icon = status.success ? 'check-circle text-success' : 'times-circle text-danger';
                    const badgeClass = status.success ? 'bg-success' : 'bg-danger';
                    
                    // עדכון עמודת "סנכרון אחרון"
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge ${badgeClass}">
                                <i class="fas fa-${status.success ? 'check' : 'times'} me-1"></i>
                                ${lastSync}
                            </span>
                            <br>
                            <small class="text-muted">
                                ${status.messages_count} הודעות, ${status.events_count} אירועים
                            </small>
                        `);
                    }
                    
                    // עדכון סטטוס סינכרון (אם קיים)
                    if (statusDiv.length) {
                        statusDiv.html(`
                            <small class="${status.success ? 'text-success' : 'text-danger'}">
                                <i class="fas fa-${icon} me-1"></i>
                                הושלם: ${status.messages_count} הודעות, ${status.events_count} אירועים
                            </small>
                        `).show();
                    }
                } else {
                    // אם לא סונכרן מעולם
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge bg-secondary">
                                <i class="fas fa-clock me-1"></i>
                                לא סונכרן
                            </span>
                        `);
                    }
                }
            })
            .fail(function() {
                const lastSyncDiv = $(`#last-sync-${itemId}`);
                if (lastSyncDiv.length) {
                    lastSyncDiv.html(`
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            שגיאה
                        </span>
                    `);
                }
            });
    }
    
    // טעינת סטטוס סינכרון לכל הפריטים
    function loadAllSyncStatus() {
        $('.sync-now').each(function() {
            const itemId = $(this).data('id');
            loadSyncStatus(itemId);
        });
    }
    
    // טעינת סטטוס סינכרון אחרי חיפוש
    setTimeout(loadAllSyncStatus, 1000);
    
    // מחיקת קבוצה
    $(document).on('click', '.delete-group', function() {
        const groupId = $(this).data('id');
        const groupName = $(this).data('name');
        
        if (confirm(`האם אתה בטוח שברצונך למחוק את הקבוצה "${groupName}"?\n\nפעולה זו תמחק את הקבוצה מהוואטסאפ שלך ומהמסד הנתונים ולא ניתן לבטל אותה.`)) {
            deleteGroup(groupId);
        }
    });
    
    // פונקציה למחיקת קבוצה
    function deleteGroup(groupId) {
        // הצגת הודעת טעינה
        showAlert('מבצע מחיקת קבוצה מהוואטסאפ... זה יכול לקחת כמה דקות', 'info');
        
        $.ajax({
            url: `/api/delete/group/${groupId}`,
            method: 'DELETE',
            timeout: 120000, // 2 דקות timeout
            success: function(response) {
                if (response.success) {
                    // הסרת השורה מהטבלה
                    $(`tr[data-group-id="${groupId}"]`).fadeOut(300, function() {
                        $(this).remove();
                    });
                    
                    // הודעת הצלחה מפורטת
                    let successMessage = 'הקבוצה נמחקה בהצלחה!';
                    if (response.whatsapp_deletion) {
                        const details = response.whatsapp_deletion;
                        if (details.participants_removed > 0) {
                            successMessage += `\nהוסרו ${details.participants_removed} משתתפים מהקבוצה.`;
                        }
                        if (details.group_left) {
                            successMessage += '\nעזבת את הקבוצה בהצלחה.';
                        }
                    }
                    if (response.api_used) {
                        const apiName = response.api_used === 'green_api' ? 'Green API' : 'Evolution API';
                        successMessage += `\nהמחיקה בוצעה באמצעות ${apiName}.`;
                    }
                    showAlert(successMessage, 'success');
                    
                    // רענון הסטטיסטיקות
                    loadStats();
                } else {
                    showAlert('שגיאה במחיקת הקבוצה: ' + (response.error || 'שגיאה לא ידועה'), 'danger');
                }
            },
            error: function(xhr) {
                let errorMessage = 'שגיאה בחיבור לשרת';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                } else if (xhr.status === 0) {
                    errorMessage = 'שגיאת timeout - הפעולה לוקחת יותר מדי זמן';
                }
                showAlert('שגיאה במחיקת הקבוצה: ' + errorMessage, 'danger');
            }
        });
    }
    
    // פונקציונליות צמצום חלון סינכרון
    $('#minimize-sync').on('click', function() {
        $('#progressModal').modal('hide');
        $('#minimized-sync').show();
        isMinimized = true;
    });
    
    $('#restore-sync').on('click', function() {
        $('#minimized-sync').hide();
        $('#progressModal').modal('show');
        isMinimized = false;
    });
    
    // פונקציה להוספת לוג
    function addSyncLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('he-IL');
        const logClass = type === 'error' ? 'text-danger' : 
                        type === 'success' ? 'text-success' : 
                        type === 'warning' ? 'text-warning' : 'text-light';
        
        const logEntry = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
        
        // הוספה לחלון הראשי
        $('#sync-logs').append(logEntry);
        $('#sync-logs').scrollTop($('#sync-logs')[0].scrollHeight);
        
        // הוספה לחלון המוקטן
        if (isMinimized) {
            $('#minimized-progress-text').text(message);
        }
    }
    
    // עדכון פונקציות הסינכרון עם לוגים
    const originalStartSync = startSync;
    startSync = function(itemId, itemType, startDate, endDate) {
        addSyncLog(`מתחיל סינכרון ${itemType}: ${itemId}`, 'info');
        addSyncLog(`תקופה: ${startDate} - ${endDate}`, 'info');
        return originalStartSync(itemId, itemType, startDate, endDate);
    };
    
    const originalUpdateProgress = updateProgress;
    updateProgress = function(status) {
        addSyncLog('מסנכרן הודעות...', 'info');
        return originalUpdateProgress(status);
    };
    
    const originalHandleSyncComplete = handleSyncComplete;
    handleSyncComplete = function(result) {
        if (result.success) {
            addSyncLog(`✅ סינכרון הושלם בהצלחה!`, 'success');
            addSyncLog(`📱 הודעות שנמצאו: ${result.messages_found}`, 'success');
            addSyncLog(`💾 הודעות שנשמרו: ${result.messages_saved}`, 'success');
            addSyncLog(`📅 אירועים שנוצרו: ${result.events_created}`, 'success');
        } else {
            addSyncLog(`❌ סינכרון נכשל: ${result.error}`, 'error');
        }
        
        // איפוס כל כפתורי הסנכרון
        $('.sync-now').each(function() {
            resetSyncButton($(this));
        });
        
        return originalHandleSyncComplete(result);
    };
    
    const originalHandleSyncError = handleSyncError;
    handleSyncError = function(error) {
        addSyncLog(`❌ שגיאה בסינכרון: ${error}`, 'error');
        
        // איפוס כל כפתורי הסנכרון
        $('.sync-now').each(function() {
            resetSyncButton($(this));
        });
        
        return originalHandleSyncError(error);
    };
});

// פונקציונליות לוגים
let autoRefreshInterval = null;
let isAutoRefreshActive = false;
let currentLogLevel = 'all';

// טעינת לוגים
function loadLogs() {
    $.ajax({
        url: '/api/logs',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayLogs(response.logs);
                updateLogCount(response.logs.length);
            } else {
                showAlert('שגיאה בטעינת לוגים: ' + (response.error || 'שגיאה לא ידועה'), 'danger');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'שגיאה בחיבור לשרת';
            showAlert('שגיאה בטעינת לוגים: ' + error, 'danger');
        }
    });
}

// הצגת לוגים
function displayLogs(logs) {
    const container = $('#logs-container');
    container.empty();
    
    if (logs.length === 0) {
        container.html('<div class="text-center text-muted p-4">אין לוגים להצגה</div>');
        return;
    }
    
    // סינון לפי רמה
    let filteredLogs = logs;
    if (currentLogLevel !== 'all') {
        filteredLogs = logs.filter(log => log.level === currentLogLevel);
    }
    
    // הצגת הלוגים (הכי חדשים למעלה)
    filteredLogs.reverse().forEach(log => {
        const logEntry = createLogEntry(log);
        container.append(logEntry);
    });
    
    // גלילה למטה
    container.scrollTop(container[0].scrollHeight);
}

// יצירת אלמנט לוג
function createLogEntry(log) {
    const timestamp = new Date(log.timestamp).toLocaleString('he-IL');
    const levelClass = log.level || 'INFO';
    
    return $(`
        <div class="log-entry ${levelClass}">
            <span class="log-timestamp">${timestamp}</span>
            <span class="log-level">[${levelClass}]</span>
            <span class="log-message">${log.message}</span>
        </div>
    `);
}

// עדכון מונה הלוגים
function updateLogCount(count) {
    $('#log-count').text(`${count} הודעות`);
}

// רענון לוגים
$('#refresh-logs').on('click', function() {
    loadLogs();
});

// ניקוי מסך הלוגים
$('#clear-logs').on('click', function() {
    $('#logs-container').empty();
    updateLogCount(0);
});

// רענון אוטומטי
$('#auto-refresh-toggle').on('click', function() {
    if (isAutoRefreshActive) {
        // עצירת רענון אוטומטי
        clearInterval(autoRefreshInterval);
        isAutoRefreshActive = false;
        $(this).removeClass('auto-refresh-active');
        $(this).html('<i class="fas fa-play me-1"></i>רענון אוטומטי');
    } else {
        // התחלת רענון אוטומטי
        autoRefreshInterval = setInterval(loadLogs, 5000); // כל 5 שניות
        isAutoRefreshActive = true;
        $(this).addClass('auto-refresh-active');
        $(this).html('<i class="fas fa-pause me-1"></i>עצור רענון');
    }
});

// סינון לפי רמת לוג
$('#log-level-filter').on('change', function() {
    currentLogLevel = $(this).val();
    loadLogs();
});

// טעינת לוגים ראשונית
$(document).ready(function() {
    // טעינת לוגים רק כשהטאב של הלוגים נפתח
    $('#logs-tab').on('shown.bs.tab', function() {
        loadLogs();
    });
});
</script>
{% endblock %}



