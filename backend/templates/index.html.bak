{% extends "base.html" %}

{% block title %}祝 转 - TimeBro Manager{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Header Section -->
            <div class="text-center mb-5 animate-fade-in">
                <h1 class="text-gradient">
                    <i class="fas fa-calendar-plus me-3"></i>
                    TimeBro Manager
                </h1>
                <p class="text-muted text-lg"> 转 砖 拽砖专 拽爪转 砖 爪专 住  TimeBro</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-6">
            <a href="/contacts" class="text-decoration-none">
                <div class="card card-glass h-100 animate-slide-in-right" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <div class="flex justify-between items-center">
                            <h3 class="mb-0">
                                <i class="fas fa-users me-2 text-primary"></i>砖 拽砖专
                            </h3>
                            <i class="fas fa-arrow-left fa-2x text-primary"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 border-end border-primary">
                                <h2 id="total-contacts" class="text-primary mb-2">{{ stats.total_contacts|default(0) }}</h2>
                                <p class="text-muted mb-0">住" 砖 拽砖专</p>
                            </div>
                            <div class="col-6">
                                <h2 id="contacts-in-calendar" class="text-success mb-2">{{ stats.contacts_in_calendar|default(0) }}</h2>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-calendar-check me-1"></i>住 
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-md-6">
            <a href="/groups" class="text-decoration-none">
                <div class="card card-glass h-100 animate-slide-in-right" style="animation-delay: 0.2s;">
                    <div class="card-header">
                        <div class="flex justify-between items-center">
                            <h3 class="mb-0">
                                <i class="fas fa-users-cog me-2 text-success"></i>拽爪转
                            </h3>
                            <i class="fas fa-arrow-left fa-2x text-success"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 border-end border-success">
                                <h2 id="total-groups" class="text-success mb-2">{{ stats.total_groups|default(0) }}</h2>
                                <p class="text-muted mb-0">住" 拽爪转</p>
                            </div>
                            <div class="col-6">
                                <h2 id="groups-in-calendar" class="text-primary mb-2">{{ stats.groups_in_calendar|default(0) }}</h2>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-calendar-check me-1"></i>住转 
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>



<!-- 住住拽转 住专 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card card-glass">
            <div class="card-header">
                <h3>
                    <i class="fas fa-chart-line me-2 text-info"></i>住住拽转 住专
                </h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h2 id="total-calendar-events" class="text-primary mb-2">{{ stats.total_calendar_events|default(0) }}</h2>
                        <p class="text-muted mb-0">住状 专注 </p>
                    </div>
                    <div class="col-md-3">
                        <h2 id="recent-calendar-events" class="text-success mb-2">{{ stats.recent_calendar_events|default(0) }}</h2>
                        <p class="text-muted mb-0">专注 -30  专</p>
                    </div>
                    <div class="col-md-3">
                        <h2 id="august-2025-events" class="text-warning mb-2">{{ stats.august_2025_events|default(0) }}</h2>
                        <p class="text-muted mb-0">专注 住 2025</p>
                    </div>
                    <div class="col-md-3">
                        <h2 id="last-sync-messages" class="text-info mb-2">{{ stats.last_sync_messages|default(0) }}</h2>
                        <p class="text-muted mb-0">注转 住专 专</p>
                    </div>
                </div>
                {% if stats.last_sync_date %}
                <div class="row mt-3">
                    <div class="col-12 text-center">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            住专 专: {{ stats.last_sync_date }}
                            {% if stats.last_sync_events > 0 %}
                            | 爪专 {{ stats.last_sync_events }} 专注
                            {% endif %}
                        </small>
                    </div>
                </div>
                {% endif %}
                
                <!-- 注 注 Rate Limiting -->
                <div class="row mt-2">
                    <div class="col-12 text-center">
                        <small class="text-info">
                            <i class="fas fa-shield-alt me-1"></i>
                            <strong>Rate Limiting 驻注:</strong> 1.2 砖转  拽砖转 | 2 砖转  住专
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 驻转专 住专  -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h3>
                    <i class="fas fa-sync me-2 text-warning"></i>住专 
                </h3>
                <p class="text-muted">住专 转  砖 拽爪转 住 </p>
                <button class="btn btn-primary btn-lg" id="sync-all-btn">
                    <i class="fas fa-sync me-2" id="sync-icon"></i>
                    <span id="sync-text">住专  注砖</span>
                </button>
                <div id="sync-all-status" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-sync fa-spin me-2"></i>
                        <span id="sync-all-text">转 住专...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 注 注 注专转 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card card-glass">
            <div class="card-header">
                <h4><i class="fas fa-info-circle me-2 text-primary"></i>注 注 注专转</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-database me-2"></i>拽专转 转</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check-circle text-success me-2"></i>Green API - 砖 拽砖专</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Evolution API - 拽爪转</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-search me-2"></i>驻砖专转 驻砖</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-user me-2"></i>驻砖 驻 砖</li>
                            <li><i class="fas fa-phone me-2"></i>驻砖 驻 住驻专 驻</li>
                            <li><i class="fas fa-calendar me-2"></i>住 驻 转专</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-filter me-2"></i>驻专 </h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-flag me-2"></i>砖专 </li>
                            <li><i class="fas fa-building me-2"></i>注住拽 </li>
                            <li><i class="fas fa-calendar-check me-2"></i>住 </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    updateStats();
    
    // 驻拽爪转 住专 
    let currentSyncId = null;
    let syncCheckInterval = null;
    
    // 砖专转  转专 -localStorage
    function saveDateRange(startDate, endDate) {
        localStorage.setItem('lastSyncRange', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    }
    
    // 注转  转专 砖专
    function loadDateRange() {
        const saved = localStorage.getItem('lastSyncRange');
        if (saved) {
            try {
                const range = JSON.parse(saved);
                return {
                    startDate: range.startDate,
                    endDate: range.endDate
                };
            } catch (e) {
                console.log('砖 注转  砖专:', e);
            }
        }
        
        // 专专转 : 1 砖 拽 注 
        const today = new Date();
        const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        return {
            startDate: lastMonth.toISOString().split('T')[0],
            endDate: today.toISOString().split('T')[0]
        };
    }
    
    // 爪 注 驻转专 住专 
    $('#sync-all-btn').on('click', function() {
        const range = loadDateRange();
        
        if (confirm(` 转 专爪 住专 转  住 ?\n转拽驻: ${range.startDate} - ${range.endDate}`)) {
            startSyncAll(range.startDate, range.endDate);
        }
    });
    
    // 转转 住专 
    function startSyncAll(startDate, endDate) {
        $('#sync-all-btn').prop('disabled', true);
        $('#sync-all-status').show();
        $('#sync-all-text').text('转 住专 ...');
        
        $.ajax({
            url: '/api/sync/all',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            }),
            success: function(response) {
                if (response.success) {
                    currentSyncId = response.sync_id;
                    $('#sync-all-text').text('住专 转 爪...');
                    startProgressCheck();
                } else {
                    showAlert('砖 转转 住专: ' + response.error, 'error');
                    resetSyncButton();
                }
            },
            error: function() {
                showAlert('砖 转拽砖专转 注 砖专转', 'error');
                resetSyncButton();
            }
        });
    }
    
    // 拽转 转拽转 住专
    function startProgressCheck() {
        if (syncCheckInterval) {
            clearInterval(syncCheckInterval);
        }
        
        syncCheckInterval = setInterval(function() {
            if (!currentSyncId) return;
            
            $.get(`/api/sync/status/${currentSyncId}`)
                .done(function(status) {
                    if (status.status === 'completed') {
                        clearInterval(syncCheckInterval);
                        handleSyncComplete(status.result);
                    } else if (status.status === 'error') {
                        clearInterval(syncCheckInterval);
                        handleSyncError(status.error);
                    } else if (status.status === 'running') {
                        updateProgress(status);
                    }
                })
                .fail(function() {
                    clearInterval(syncCheckInterval);
                    handleSyncError('砖 拽转 住住');
                });
        }, 3000); // 拽  3 砖转
    }
    
    // 注 转拽转
    function updateProgress(status) {
        $('#sync-all-text').text('住专 注转...');
    }
    
    // 砖转 住专
    function handleSyncComplete(result) {
        if (result.success) {
            const message = `住专  砖 爪!<br>
                            砖 拽砖专: ${result.total_contacts}<br>
                            拽爪转: ${result.total_groups}<br>
                            住" 注转: ${result.total_messages}<br>
                            住" 专注: ${result.total_events}`;
            showAlert(message, 'success');
            
            // 注 住住拽转
            updateStats();
        } else {
            showAlert('住专  砖: ' + result.error, 'error');
        }
        
        resetSyncButton();
        currentSyncId = null;
    }
    
    // 砖 住专
    function handleSyncError(error) {
        showAlert('砖 住专 : ' + error, 'error');
        resetSyncButton();
        currentSyncId = null;
    }
    
    // 驻住 驻转专 住专
    function resetSyncButton() {
        $('#sync-all-btn').prop('disabled', false);
        $('#sync-all-status').hide();
    }
});
</script>
{% endblock %}



