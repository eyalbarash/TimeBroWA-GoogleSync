{% extends "base.html" %}

{% block title %}× ×™×”×•×œ ×× ×©×™ ×§×©×¨{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4 animate-fade-in-up">
        <div class="col-12">
            <h1 class="heading-1">
                <i class="fas fa-users me-3 text-primary"></i>
                × ×™×”×•×œ ×× ×©×™ ×§×©×¨
            </h1>
            <p class="lead" style="color: hsl(var(--muted-foreground)); font-weight: var(--font-medium);">×—×¤×© ×•×¡× ×Ÿ ××ª ×× ×©×™ ×”×§×©×¨ ×©×œ×š, ×•×‘×—×¨ ××™ ×™×›× ×¡ ×œ×™×•××Ÿ TimeBro</p>
        </div>
    </div>

<!-- ×˜×•×¤×¡ ×—×™×¤×•×© -->
<div class="form-modern mb-4 animate-slide-in-right" style="animation-delay: 0.1s;">
    <form id="search-form">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="search-term" class="form-label">
                    <i class="fas fa-search me-1"></i>×—×™×¤×•×© ×œ×¤×™ ×©×
                </label>
                <input type="text" class="form-control form-control-modern" id="search-term" placeholder="×”×–×Ÿ ×©× ×œ×—×™×¤×•×©...">
            </div>
            
            <div class="col-md-4 mb-3">
                <label for="phone-filter" class="form-label">
                    <i class="fas fa-phone me-1"></i>××¡×¤×¨ ×˜×œ×¤×•×Ÿ
                </label>
                <input type="text" class="form-control form-control-modern" id="phone-filter" placeholder="×”×–×Ÿ ××¡×¤×¨ ××• ×—×œ×§ ×××¡×¤×¨...">
            </div>
            
            <div class="col-md-4 mb-3">
                <label class="form-label">
                    <i class="fas fa-filter me-1"></i>×¤×™×œ×˜×¨×™×
                </label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="israeli-only">
                        <label class="form-check-label" for="israeli-only">
                            <i class="fas fa-flag israeli-flag me-1"></i>×™×©×¨××œ×™×™× ×‘×œ×‘×“
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="business-only">
                        <label class="form-check-label" for="business-only">
                            <i class="fas fa-building business-icon me-1"></i>×¢×¡×§×™× ×‘×œ×‘×“
                        </label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="personal-only" checked>
                        <label class="form-check-label" for="personal-only">
                            <i class="fas fa-user-check text-primary me-1"></i>×× ×©×™ ×§×©×¨ ××™×©×™×™× ×‘×œ×‘×“
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="date-from" class="form-label">
                    <i class="fas fa-calendar me-1"></i>××ª××¨×™×š
                </label>
                <input type="date" class="form-control" id="date-from">
            </div>
            
            <div class="col-md-3 mb-3">
                <label for="date-to" class="form-label">
                    <i class="fas fa-calendar me-1"></i>×¢×“ ×ª××¨×™×š
                </label>
                <input type="date" class="form-control" id="date-to">
            </div>
            
            <div class="col-md-3 mb-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="calendar-only">
                        <label class="form-check-label fw-semibold" for="calendar-only">
                            <i class="fas fa-calendar-check me-1 text-success"></i>××¡×•×× ×™× ×œ×™×•××Ÿ ×‘×œ×‘×“
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn-modern btn-primary-modern me-2">
                        <i class="fas fa-search me-1"></i>×—×¤×©
                    </button>
                    <button type="button" class="btn-modern btn-error-modern" id="clear-search">
                        <i class="fas fa-times me-1"></i>× ×§×”
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Loading -->
<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">×˜×•×¢×Ÿ...</span>
    </div>
    <p class="mt-2">××—×¤×© ×× ×©×™ ×§×©×¨...</p>
</div>

<!-- ×ª×•×¦××•×ª -->
<div id="results-container" style="display: none;">
    <!-- ×›×•×ª×¨×ª ×ª×•×¦××•×ª -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="results-title">×ª×•×¦××•×ª ×—×™×¤×•×©</h4>
        <div class="btn-group" role="group">
            <button type="button" class="btn-modern btn-success-modern btn-sm" id="select-all-calendar">
                <i class="fas fa-check-double me-1"></i>×‘×—×¨ ×”×›×œ ×œ×™×•××Ÿ
            </button>
            <button type="button" class="btn-modern btn-error-modern btn-sm" id="deselect-all-calendar">
                <i class="fas fa-times me-1"></i>×‘×˜×œ ×‘×—×™×¨×ª ×”×›×œ
            </button>
        </div>
    </div>

    <!-- ×˜×‘×œ×ª ×ª×•×¦××•×ª -->
    <div class="results-table">
        <div class="table-responsive">
            <table class="table table-modern mb-0">
                <thead>
                    <tr>
                        <th>×©×</th>
                        <th>××¡×¤×¨ ×˜×œ×¤×•×Ÿ</th>
                        <th>×©× ×—×‘×¨×”</th>
                        <th>××“×™× ×”</th>
                        <th>×¡×•×’</th>
                        <th>×©× ×‘-Google Contacts</th>
                        <th>×©× ×‘×•×•××˜×¡××¤</th>
                        <th>× ×•×¦×¨</th>
                        <th>×¢×•×“×›×Ÿ</th>
                        <th>×›×œ×•×œ ×‘×™×•××Ÿ</th>
                        <th>×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ</th>
                        <th>×¡× ×›×¨×•×Ÿ</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <nav>
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
        <p class="text-muted" id="results-info"></p>
    </div>
</div>

<!-- ×”×•×“×¢×” ×× ××™×Ÿ ×ª×•×¦××•×ª -->
<div id="no-results" style="display: none;">
    <div class="alert alert-info text-center">
        <i class="fas fa-search fa-2x mb-3"></i>
        <h5>×œ× × ××¦××• ×ª×•×¦××•×ª</h5>
        <p>× ×¡×” ×œ×©× ×•×ª ××ª ×§×¨×™×˜×¨×™×•× ×™ ×”×—×™×¤×•×©</p>
    </div>
</div>

<!-- ×¤×•×¤××¤ ×”×•×¡×¤×ª ×× ×©×™ ×§×©×¨ ×œ-Google -->
<div class="modal fade" id="addToGoogleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2 text-success"></i>×”×•×¡×¤×ª ××™×© ×§×©×¨ ×œ-Google Contacts
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-to-google-form">
                    <input type="hidden" id="add-contact-id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add-contact-name" class="form-label">
                                <i class="fas fa-user me-1"></i>×©× ××œ×
                            </label>
                            <input type="text" class="form-control form-control-modern" id="add-contact-name" required>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="add-contact-phone" class="form-label">
                                <i class="fas fa-phone me-1"></i>××¡×¤×¨ ×˜×œ×¤×•×Ÿ
                            </label>
                            <input type="tel" class="form-control form-control-modern" id="add-contact-phone" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="add-contact-company" class="form-label">
                                <i class="fas fa-building me-1"></i>×©× ×—×‘×¨×”
                            </label>
                            <input type="text" class="form-control form-control-modern" id="add-contact-company">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="add-contact-email" class="form-label">
                                <i class="fas fa-envelope me-1"></i>××™××™×™×œ (××•×¤×¦×™×•× ×œ×™)
                            </label>
                            <input type="email" class="form-control form-control-modern" id="add-contact-email">
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>××™×“×¢:</strong> ××™×© ×”×§×©×¨ ×™×•×¡×£ ×œ×—×©×‘×•×Ÿ Google ×©×œ×š (eyal@barash.co.il) ×•×™×•×¤×™×¢ ×‘×¨×©×™××ª ×× ×©×™ ×”×§×©×¨ ×”××™×©×™×™×.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-success" id="confirm-add-to-google">
                    <i class="fas fa-plus me-1"></i>×”×•×¡×£ ×œ-Google Contacts
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ×¤×•×¤××¤ ×‘×—×™×¨×ª ×ª×§×•×¤×” -->
<div class="modal fade" id="syncModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync me-2"></i>×‘×—×™×¨×ª ×ª×§×•×¤×ª ×¡×™× ×›×¨×•×Ÿ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sync-form">
                    <input type="hidden" id="sync-item-id">
                    <input type="hidden" id="sync-item-type">
                    
                    <div class="mb-3">
                        <label for="sync-start-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>××ª××¨×™×š
                        </label>
                        <input type="date" class="form-control" id="sync-start-date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sync-end-date" class="form-label">
                            <i class="fas fa-calendar me-1"></i>×¢×“ ×ª××¨×™×š
                        </label>
                        <input type="date" class="form-control" id="sync-end-date" required>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>××™×“×¢:</strong> ×”×¡×™× ×›×¨×•×Ÿ ×™×›×œ×•×œ ×”×•×“×¢×•×ª ×˜×§×¡×˜ ×‘×œ×‘×“ ×•×™×•×¡×™×£ ××™×¨×•×¢×™× ×œ×™×•××Ÿ Google.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">×‘×™×˜×•×œ</button>
                <button type="button" class="btn-modern btn-primary-modern" id="confirm-sync">
                    <i class="fas fa-sync me-1"></i>×”×ª×—×œ ×¡×™× ×›×¨×•×Ÿ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ×¤×•×¤××¤ ×”×ª×§×“××•×ª ×¡×™× ×›×¨×•×Ÿ -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync fa-spin me-2"></i>××¡× ×›×¨×Ÿ...
                </h5>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="minimize-sync">
                    <i class="fas fa-window-minimize"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progress-text">××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ...</div>
                <div id="progress-details" class="mt-2"></div>
                
                <!-- ×œ×•×’×™× ××¤×•×¨×˜×™× -->
                <div class="mt-3">
                    <h6><i class="fas fa-list me-2"></i>×œ×•×’ ×¤×¢×™×œ×•×ª:</h6>
                    <div id="sync-logs" class="bg-dark text-light p-2 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div class="text-success">[××ª×—×™×œ] ××¢×¨×›×ª ×¡×™× ×›×¨×•×Ÿ ×”×•×¤×¢×œ×”...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-sync-modal" style="display: none;">
                    <i class="fas fa-times me-1"></i>×¡×’×•×¨
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ×—×œ×•×Ÿ ××•×§×˜×Ÿ ×œ×¡×™× ×›×¨×•×Ÿ -->
<div id="minimized-sync" class="position-fixed bottom-0 end-0 p-3" style="display: none; z-index: 1050;">
    <div class="card shadow" style="width: 300px;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-sync fa-spin me-2"></i>××¡× ×›×¨×Ÿ...
            </h6>
            <button type="button" class="btn btn-sm btn-outline-primary" id="restore-sync">
                <i class="fas fa-window-restore"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div id="minimized-progress-text" class="small">××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentFilters = {};

// ×—×™×¤×•×© ×× ×©×™ ×§×©×¨
function searchContacts(page = 1) {
    currentPage = page;
    
    // ××™×¡×•×£ ×¤×¨××˜×¨×™ ×—×™×¤×•×©
    const params = {
        search: $('#search-term').val(),
        phone: $('#phone-filter').val(),
        date_from: $('#date-from').val(),
        date_to: $('#date-to').val(),
        calendar_only: $('#calendar-only').is(':checked'),
        page: page,
        per_page: 50
    };
    
    // ×¤×™×œ×˜×¨×™× × ×•×¡×¤×™×
    if ($('#israeli-only').is(':checked')) {
        params.israeli_only = true;
    }
    if ($('#business-only').is(':checked')) {
        params.business_only = true;
    }
    if ($('#personal-only').is(':checked')) {
        params.personal_only = true;
    }
    
    currentFilters = params;
    
    showLoading();
    $('#results-container, #no-results').hide();
    
    $.get('/api/search/contacts', params)
        .done(function(data) {
            hideLoading();
            
            if (data.error) {
                showAlert('×©×’×™××” ×‘×—×™×¤×•×©: ' + data.error, 'error');
                return;
            }
            
            if (data.contacts && data.contacts.length > 0) {
                displayResults(data);
            } else {
                $('#no-results').show();
            }
        })
        .fail(function() {
            hideLoading();
            showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
        });
}

// ×”×¦×’×ª ×ª×•×¦××•×ª
function displayResults(data) {
    const tbody = $('#results-tbody');
    tbody.empty();
    
    data.contacts.forEach(function(contact) {
        const row = createContactRow(contact);
        tbody.append(row);
    });
    
    // ×¢×“×›×•×Ÿ ××™×“×¢ ×ª×•×¦××•×ª
    const start = (data.page - 1) * data.per_page + 1;
    const end = Math.min(start + data.contacts.length - 1, data.total);
    $('#results-info').text(`××¦×™×’ ${start}-${end} ××ª×•×š ${data.total.toLocaleString()} ×ª×•×¦××•×ª`);
    $('#results-title').text(`× ××¦××• ${data.total.toLocaleString()} ×× ×©×™ ×§×©×¨`);
    
    // ×¢×“×›×•×Ÿ pagination
    updatePagination(data);
    
    $('#results-container').show();
}

// ×™×¦×™×¨×ª ×©×•×¨×” ×‘×˜×‘×œ×”
function createContactRow(contact) {
    const flags = [];
    
    if (contact.is_israeli) {
        flags.push('<i class="fas fa-flag israeli-flag me-1" title="×™×©×¨××œ×™"></i>');
    }
    if (contact.is_business) {
        flags.push('<i class="fas fa-building business-icon me-1" title="×¢×¡×§"></i>');
    }
    if (contact.is_group) {
        flags.push('<i class="fas fa-users group-icon me-1" title="×§×‘×•×¦×”"></i>');
    }
    
    const calendarButton = contact.include_in_timebro ? 
        `<button class="btn btn-calendar-yes btn-sm toggle-calendar" data-id="${contact.contact_id}" data-status="1">
            <i class="fas fa-calendar-check me-1"></i>×›×œ×•×œ
        </button>` :
        `<button class="btn btn-calendar-no btn-sm toggle-calendar" data-id="${contact.contact_id}" data-status="0">
            <i class="fas fa-calendar-times me-1"></i>×œ× ×›×œ×•×œ
        </button>`;
    
    return `
        <tr>
            <td>
                <strong>${contact.push_name || contact.name || contact.phone_number || '×œ×œ× ×©×'}</strong>
                ${contact.name && contact.name !== contact.push_name ? 
                    `<br><small class="text-muted">${contact.name}</small>` : ''}
            </td>
            <td>
                <span dir="ltr">${contact.phone_number || '×œ×œ× ××¡×¤×¨'}</span>
            </td>
            <td>
                <span class="company-name-editable" 
                      data-id="${contact.contact_id}" 
                      data-type="contact"
                      style="cursor: pointer; border-bottom: 1px dashed #007bff; color: #007bff;"
                      title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×”×—×‘×¨×”">
                    ${contact.company_name || '×œ×—×¥ ×œ×”×’×“×¨×”'}
                </span>
            </td>
            <td>
                ${flags.join('')}
                <span class="country-name" data-phone="${contact.phone_number}">
                    ${getCountryFromPhone(contact.phone_number)}
                </span>
            </td>
            <td>
                <span class="badge bg-secondary">${contact.type || 'user'}</span>
            </td>
            <td>
                <span class="google-contact-name-editable" 
                      data-id="${contact.contact_id}" 
                      data-type="google_contact"
                      style="cursor: pointer; border-bottom: 1px dashed #28a745; color: #28a745;"
                      title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×‘-Google Contacts">
                    ${contact.google_contact_name || '×œ×—×¥ ×œ×”×’×“×¨×”'}
                </span>
            </td>
            <td>
                <span class="whatsapp-name-editable" 
                      data-id="${contact.contact_id}" 
                      data-type="whatsapp_name"
                      style="cursor: pointer; border-bottom: 1px dashed #25d366; color: #25d366;"
                      title="×œ×—×¥ ×œ×¢×¨×™×›×ª ×©× ×‘×•×•××˜×¡××¤">
                    ${contact.whatsapp_personal_name || '×œ×—×¥ ×œ×”×’×“×¨×”'}
                </span>
            </td>
            <td>
                <small>${formatDate(contact.created_at)}</small>
            </td>
            <td>
                <small>${formatDate(contact.updated_at)}</small>
            </td>
            <td>
                ${calendarButton}
            </td>
            <td>
                <div class="last-sync" id="last-sync-${contact.contact_id}">
                    <span class="badge bg-secondary">
                        <i class="fas fa-clock me-1"></i>
                        ×œ× ×¡×•× ×›×¨×Ÿ
                    </span>
                </div>
            </td>
            <td>
                ${contact.google_contact_name ? 
                    `<button class="btn-modern btn-primary-modern btn-sm sync-now" data-id="${contact.contact_id}" data-type="contact">
                        <i class="fas fa-sync me-1"></i>×¡× ×›×¨×Ÿ ×¢×›×©×™×•
                    </button>` :
                    `<button class="btn-modern btn-success-modern btn-sm add-to-google" data-id="${contact.contact_id}" data-name="${contact.name}" data-phone="${contact.phone_number}" data-company="${contact.company_name || ''}">
                        <i class="fas fa-plus me-1"></i>×”×•×¡×¤×” ×œ×× ×©×™ ×”×§×©×¨
                    </button>`
                }
                <div class="sync-status" id="sync-status-${contact.contact_id}" style="display: none;">
                    <small class="text-muted">××¡× ×›×¨×Ÿ...</small>
                </div>
            </td>
        </tr>
    `;
}

// ×¢×“×›×•×Ÿ pagination
function updatePagination(data) {
    const pagination = $('#pagination');
    pagination.empty();
    
    if (data.total_pages <= 1) return;
    
    // ×›×¤×ª×•×¨ ×”×§×•×“×
    if (data.page > 1) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchContacts(${data.page - 1})">×”×§×•×“×</a>
            </li>
        `);
    }
    
    // ××¡×¤×¨×™ ×¢××•×“×™×
    const startPage = Math.max(1, data.page - 2);
    const endPage = Math.min(data.total_pages, data.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === data.page ? 'active' : '';
        pagination.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" onclick="searchContacts(${i})">${i}</a>
            </li>
        `);
    }
    
    // ×›×¤×ª×•×¨ ×”×‘×
    if (data.page < data.total_pages) {
        pagination.append(`
            <li class="page-item">
                <a class="page-link" href="#" onclick="searchContacts(${data.page + 1})">×”×‘×</a>
            </li>
        `);
    }
}

// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×™×•××Ÿ
function toggleCalendarStatus(contactId, currentStatus) {
    const newStatus = currentStatus === 1 ? 0 : 1;
    
    $.ajax({
        url: `/api/update/contact/${contactId}`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ include_in_timebro: newStatus === 1 }),
        success: function(response) {
            if (response.error) {
                showAlert('×©×’×™××” ×‘×¢×“×›×•×Ÿ: ' + response.error, 'error');
                return;
            }
            
            // ×¢×“×›×•×Ÿ ×”×›×¤×ª×•×¨
            const button = $(`.toggle-calendar[data-id="${contactId}"]`);
            if (newStatus === 1) {
                button.removeClass('btn-calendar-no').addClass('btn-calendar-yes')
                      .attr('data-status', '1')
                      .html('<i class="fas fa-calendar-check me-1"></i>×›×œ×•×œ');
            } else {
                button.removeClass('btn-calendar-yes').addClass('btn-calendar-no')
                      .attr('data-status', '0')
                      .html('<i class="fas fa-calendar-times me-1"></i>×œ× ×›×œ×•×œ');
            }
            
            updateStats();
            showAlert('×”×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        },
        error: function() {
            showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
        }
    });
}

// ×¤×•×¨××˜ ×ª××¨×™×š
function formatDate(dateString) {
    if (!dateString) return '×œ× ×™×“×•×¢';
    const date = new Date(dateString);
    return date.toLocaleDateString('he-IL') + ' ' + date.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
}

// ×–×™×”×•×™ ××“×™× ×” ×œ×¤×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
function getCountryFromPhone(phoneNumber) {
    if (!phoneNumber) return '×œ× ×™×“×•×¢';
    
    // ×”×¡×¨×ª ×ª×•×•×™× ×œ× ×¨×œ×•×•× ×˜×™×™×
    const cleanPhone = phoneNumber.replace(/[^\d+]/g, '');
    
    // ××™×¤×•×™ ×§×™×“×•××•×ª ××“×™× ×•×ª
    const countryCodes = {
        '972': '×™×©×¨××œ ğŸ‡®ğŸ‡±',
        '1': '××¨×¦×•×ª ×”×‘×¨×™×ª ğŸ‡ºğŸ‡¸',
        '44': '×‘×¨×™×˜× ×™×” ğŸ‡¬ğŸ‡§',
        '49': '×’×¨×× ×™×” ğŸ‡©ğŸ‡ª',
        '33': '×¦×¨×¤×ª ğŸ‡«ğŸ‡·',
        '39': '××™×˜×œ×™×” ğŸ‡®ğŸ‡¹',
        '34': '×¡×¤×¨×“ ğŸ‡ªğŸ‡¸',
        '7': '×¨×•×¡×™×” ğŸ‡·ğŸ‡º',
        '86': '×¡×™×Ÿ ğŸ‡¨ğŸ‡³',
        '81': '×™×¤×Ÿ ğŸ‡¯ğŸ‡µ',
        '82': '×“×¨×•× ×§×•×¨×™××” ğŸ‡°ğŸ‡·',
        '91': '×”×•×“×• ğŸ‡®ğŸ‡³',
        '55': '×‘×¨×–×™×œ ğŸ‡§ğŸ‡·',
        '61': '××•×¡×˜×¨×œ×™×” ğŸ‡¦ğŸ‡º',
        '27': '×“×¨×•× ××¤×¨×™×§×” ğŸ‡¿ğŸ‡¦',
        '20': '××¦×¨×™× ğŸ‡ªğŸ‡¬',
        '966': '×¢×¨×‘ ×”×¡×¢×•×“×™×ª ğŸ‡¸ğŸ‡¦',
        '971': '××™×—×•×“ ×”×××™×¨×•×™×•×ª ğŸ‡¦ğŸ‡ª',
        '965': '×›×•×•×™×ª ğŸ‡°ğŸ‡¼',
        '974': '×§×˜×¨ ğŸ‡¶ğŸ‡¦',
        '973': '×‘×—×¨×™×™×Ÿ ğŸ‡§ğŸ‡­',
        '968': '×¢×•×××Ÿ ğŸ‡´ğŸ‡²'
    };
    
    // ×‘×“×™×§×” ×× ×”××¡×¤×¨ ××ª×—×™×œ ×‘-+
    if (cleanPhone.startsWith('+')) {
        const phoneWithoutPlus = cleanPhone.substring(1);
        
        // ×‘×“×™×§×” ×œ×¤×™ ×§×™×“×•××•×ª ××¨×•×›×•×ª ×™×•×ª×¨ ×§×•×“×
        for (const [code, country] of Object.entries(countryCodes)) {
            if (phoneWithoutPlus.startsWith(code)) {
                return country;
            }
        }
    }
    
    // ×‘×“×™×§×” ×œ×œ× +
    for (const [code, country] of Object.entries(countryCodes)) {
        if (cleanPhone.startsWith(code)) {
            return country;
        }
    }
    
    return '×œ× ×™×“×•×¢';
}

// ××™×¨×•×¢×™×
$(document).ready(function() {
    // ×—×™×¤×•×© ×‘×˜×•×¤×¡
    $('#search-form').on('submit', function(e) {
        e.preventDefault();
        searchContacts(1);
    });
    
    // × ×™×§×•×™ ×—×™×¤×•×©
    $('#clear-search').on('click', function() {
        $('#search-form')[0].reset();
        $('#results-container, #no-results').hide();
    });
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×™×•××Ÿ
    $(document).on('click', '.toggle-calendar', function() {
        const contactId = $(this).data('id');
        const currentStatus = parseInt($(this).data('status'));
        toggleCalendarStatus(contactId, currentStatus);
    });
    
    // ×‘×—×™×¨×ª ×”×›×œ ×œ×™×•××Ÿ
    $('#select-all-calendar').on('click', function() {
        $('.toggle-calendar[data-status="0"]').each(function() {
            const contactId = $(this).data('id');
            toggleCalendarStatus(contactId, 0);
        });
    });
    
    // ×‘×™×˜×•×œ ×‘×—×™×¨×ª ×”×›×œ
    $('#deselect-all-calendar').on('click', function() {
        $('.toggle-calendar[data-status="1"]').each(function() {
            const contactId = $(this).data('id');
            toggleCalendarStatus(contactId, 1);
        });
    });
    
    // ×—×™×¤×•×© ××•×˜×•××˜×™ ×‘×”×§×œ×“×”
    $('#search-term, #phone-filter').on('input', function() {
        clearTimeout(window.searchTimer);
        window.searchTimer = setTimeout(function() {
            if ($('#search-term').val().length >= 2 || $('#phone-filter').val().length >= 3) {
                searchContacts(1);
            }
        }, 500);
    });
    
    // ×¢×¨×™×›×ª ×©× ×—×‘×¨×” - inline editing
    $(document).on('click', '.company-name-editable', function() {
        editInlineField($(this), 'company', '×©× ×”×—×‘×¨×”');
    });
    
    // ×¢×¨×™×›×ª ×©× Google Contacts - inline editing
    $(document).on('click', '.google-contact-name-editable', function() {
        editInlineField($(this), 'google_contact', '×©× ×‘-Google Contacts');
    });
    
    // ×¢×¨×™×›×ª ×©× ×•×•××˜×¡××¤ - inline editing
    $(document).on('click', '.whatsapp-name-editable', function() {
        editInlineField($(this), 'whatsapp_name', '×©× ×‘×•×•××˜×¡××¤');
    });
    
    // ×”×•×¡×¤×ª ×× ×©×™ ×§×©×¨ ×œ-Google
    $(document).on('click', '.add-to-google', function() {
        const contactId = $(this).data('id');
        const contactName = $(this).data('name');
        const contactPhone = $(this).data('phone');
        const contactCompany = $(this).data('company');
        
        $('#add-contact-id').val(contactId);
        $('#add-contact-name').val(contactName);
        $('#add-contact-phone').val(contactPhone);
        $('#add-contact-company').val(contactCompany);
        $('#add-contact-email').val('');
        
        $('#addToGoogleModal').modal('show');
    });
    
    // ××™×©×•×¨ ×”×•×¡×¤×” ×œ-Google
    $('#confirm-add-to-google').on('click', function() {
        const contactId = $('#add-contact-id').val();
        const contactName = $('#add-contact-name').val();
        const contactPhone = $('#add-contact-phone').val();
        const contactCompany = $('#add-contact-company').val();
        const contactEmail = $('#add-contact-email').val();
        
        if (!contactName || !contactPhone) {
            showAlert('× × ×œ××œ× ×©× ×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ', 'error');
            return;
        }
        
        // ×”×•×¡×¤×” ×œ-Google Contacts
        $.ajax({
            url: `/api/add-to-google/${contactId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                name: contactName,
                phone: contactPhone,
                company: contactCompany,
                email: contactEmail
            }),
            success: function(response) {
                if (response.success) {
                    showAlert('××™×© ×”×§×©×¨ × ×•×¡×£ ×œ-Google Contacts ×‘×”×¦×œ×—×”!', 'success');
                    $('#addToGoogleModal').modal('hide');
                    // ×¨×¢× ×•×Ÿ ×”×¨×©×™××”
                    searchContacts(currentPage);
                } else {
                    showAlert('×©×’×™××” ×‘×”×•×¡×¤×” ×œ-Google: ' + response.error, 'error');
                }
            },
            error: function() {
                showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
            }
        });
    });
    
    // ×¤×•× ×§×¦×™×” ×›×œ×œ×™×ª ×œ×¢×¨×™×›×ª ×©×“×•×ª inline
    function editInlineField($span, fieldType, fieldLabel) {
        const contactId = $span.data('id');
        const currentValue = $span.text() === '×œ×—×¥ ×œ×”×’×“×¨×”' ? '' : $span.text();
        
        const $input = $('<input type="text" class="form-control form-control-sm" style="max-width: 200px;">');
        $input.val(currentValue);
        
        $span.replaceWith($input);
        $input.focus();
        
        // ×©××™×¨×” ×‘-Enter ××• blur
        $input.on('blur keypress', function(e) {
            if (e.type === 'blur' || e.which === 13) {
                const newValue = $input.val().trim();
                
                // ×©××™×¨×” ×œ×©×¨×ª
                $.ajax({
                    url: `/api/update/contact/${contactId}/${fieldType}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ [fieldType]: newValue }),
                    success: function(response) {
                        const color = fieldType === 'google_contact' ? '#28a745' :
                                     fieldType === 'whatsapp_name' ? '#25d366' : '#007bff';
                        // ×”×©×ª××© ×‘×¢×¨×š ×©×—×–×¨ ××”×©×¨×ª
                        const savedValue = response.google_contact_name || response.whatsapp_name || newValue;
                        const displayValue = savedValue || '×œ×—×¥ ×œ×”×’×“×¨×”';
                        const $newSpan = $(`<span class="${fieldType}-name-editable" data-id="${contactId}" data-type="${fieldType}" style="cursor: pointer; border-bottom: 1px dashed ${color}; color: ${color};" title="×œ×—×¥ ×œ×¢×¨×™×›×ª ${fieldLabel}">${displayValue}</span>`);
                        $input.replaceWith($newSpan);
                        showAlert(`${fieldLabel} ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”`);
                    },
                    error: function() {
                        const color = fieldType === 'google_contact' ? '#28a745' :
                                     fieldType === 'whatsapp_name' ? '#25d366' : '#007bff';
                        const $newSpan = $(`<span class="${fieldType}-name-editable" data-id="${contactId}" data-type="${fieldType}" style="cursor: pointer; border-bottom: 1px dashed ${color}; color: ${color};" title="×œ×—×¥ ×œ×¢×¨×™×›×ª ${fieldLabel}">${currentValue || '×œ×—×¥ ×œ×”×’×“×¨×”'}</span>`);
                        $input.replaceWith($newSpan);
                        showAlert(`×©×’×™××” ×‘×¢×“×›×•×Ÿ ${fieldLabel}`, 'error');
                    }
                });
                
                e.preventDefault();
            }
        });
    }
    
    // ×—×™×¤×•×© ×¨××©×•× ×™
    searchContacts(1);
    
    // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¡×™× ×›×¨×•×Ÿ
    let currentSyncId = null;
    let syncCheckInterval = null;
    let isMinimized = false;
    
    // ×©××™×¨×ª ×˜×•×•×— ×ª××¨×™×›×™× ×‘-localStorage
    function saveDateRange(startDate, endDate) {
        localStorage.setItem('lastSyncRange', JSON.stringify({
            startDate: startDate,
            endDate: endDate
        }));
    }
    
    // ×˜×¢×™× ×ª ×˜×•×•×— ×ª××¨×™×›×™× ×©××•×¨
    function loadDateRange() {
        const saved = localStorage.getItem('lastSyncRange');
        if (saved) {
            try {
                const range = JSON.parse(saved);
                $('#sync-start-date').val(range.startDate);
                $('#sync-end-date').val(range.endDate);
            } catch (e) {
                console.log('×©×’×™××” ×‘×˜×¢×™× ×ª ×˜×•×•×— ×©××•×¨:', e);
            }
        } else {
            // ×‘×¨×™×¨×ª ××—×“×œ: 1 ×œ×—×•×“×© ×”×§×•×“× ×¢×“ ×”×™×•×
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            $('#sync-start-date').val(lastMonth.toISOString().split('T')[0]);
            $('#sync-end-date').val(today.toISOString().split('T')[0]);
        }
    }
    
    // ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×¡×™× ×›×¨×•×Ÿ
    $(document).on('click', '.sync-now', function() {
        const itemId = $(this).data('id');
        const itemType = $(this).data('type');
        
        $('#sync-item-id').val(itemId);
        $('#sync-item-type').val(itemType);
        
        // ×˜×¢×™× ×ª ×˜×•×•×— ×©××•×¨
        loadDateRange();
        
        // ×”×¦×’×ª ×”×¤×•×¤××¤
        $('#syncModal').modal('show');
    });
    
    // ××™×©×•×¨ ×¡×™× ×›×¨×•×Ÿ
    $('#confirm-sync').on('click', function() {
        const itemId = $('#sync-item-id').val();
        const itemType = $('#sync-item-type').val();
        const startDate = $('#sync-start-date').val();
        const endDate = $('#sync-end-date').val();
        
        if (!startDate || !endDate) {
            showAlert('× × ×œ×‘×—×•×¨ ×ª××¨×™×›×™ ×”×ª×—×œ×” ×•×¡×™×•×', 'error');
            return;
        }
        
        // ×©××™×¨×ª ×”×˜×•×•×—
        saveDateRange(startDate, endDate);
        
        // ×¡×’×™×¨×ª ×¤×•×¤××¤ ×‘×—×™×¨×”
        $('#syncModal').modal('hide');
        
        // ×”×¦×’×ª ×¤×•×¤××¤ ×”×ª×§×“××•×ª
        $('#progressModal').modal('show');
        
        // ×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ
        startSync(itemId, itemType, startDate, endDate);
    });
    
    // ×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ
    function startSync(itemId, itemType, startDate, endDate) {
        const url = itemType === 'contact' ? 
            `/api/sync/contact/${itemId}` : 
            `/api/sync/group/${itemId}`;
        
        $.ajax({
            url: url,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                start_date: startDate,
                end_date: endDate
            }),
            success: function(response) {
                if (response.success) {
                    currentSyncId = response.sync_id;
                    $('#progress-text').text('×¡×™× ×›×¨×•×Ÿ ×”×•×ª×—×œ ×‘×”×¦×œ×—×”...');
                    startProgressCheck();
                } else {
                    showAlert('×©×’×™××” ×‘×”×ª×—×œ×ª ×¡×™× ×›×¨×•×Ÿ: ' + response.error, 'error');
                    $('#progressModal').modal('hide');
                }
            },
            error: function() {
                showAlert('×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª', 'error');
                $('#progressModal').modal('hide');
            }
        });
    }
    
    // ×‘×“×™×§×ª ×”×ª×§×“××•×ª ×¡×™× ×›×¨×•×Ÿ
    function startProgressCheck() {
        if (syncCheckInterval) {
            clearInterval(syncCheckInterval);
        }
        
        syncCheckInterval = setInterval(function() {
            if (!currentSyncId) return;
            
            $.get(`/api/sync/status/${currentSyncId}`)
                .done(function(status) {
                    if (status.status === 'completed') {
                        clearInterval(syncCheckInterval);
                        handleSyncComplete(status.result);
                    } else if (status.status === 'error') {
                        clearInterval(syncCheckInterval);
                        handleSyncError(status.error);
                    } else if (status.status === 'running') {
                        updateProgress(status);
                    }
                })
                .fail(function() {
                    clearInterval(syncCheckInterval);
                    handleSyncError('×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡');
                });
        }, 2000); // ×‘×“×™×§×” ×›×œ 2 ×©× ×™×•×ª
    }
    
    // ×¢×“×›×•×Ÿ ×”×ª×§×“××•×ª
    function updateProgress(status) {
        $('#progress-text').text('××¡× ×›×¨×Ÿ ×”×•×“×¢×•×ª...');
        $('#progress-details').html(`
            <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                ×”×ª×—×™×œ ×‘-${new Date(status.started_at).toLocaleString('he-IL')}
            </small>
        `);
    }
    
    // ×”×©×œ××ª ×¡×™× ×›×¨×•×Ÿ
    function handleSyncComplete(result) {
        $('#progressModal').modal('hide');
        
        if (result.success) {
            const message = `×¡×™× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!<br>
                           ğŸ“± ×”×•×“×¢×•×ª ×©× ××¦××•: ${result.messages_found}<br>
                           ğŸ’¾ ×”×•×“×¢×•×ª ×©× ×©××¨×•: ${result.messages_saved}<br>
                           ğŸ“… ××™×¨×•×¢×™× ×©× ×•×¦×¨×•: ${result.events_created}`;
            showAlert(message, 'success');
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×××©×§
            updateSyncStatus(result.contact_id || result.group_id, result);
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
            updateStats();
            
            // ×¨×¢× ×•×Ÿ ×¨×©×™××”
            searchContacts(currentPage);
        } else {
            showAlert('×¡×™× ×›×¨×•×Ÿ × ×›×©×œ: ' + result.error, 'error');
        }
        
        currentSyncId = null;
    }
    
    // ×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ
    function handleSyncError(error) {
        $('#progressModal').modal('hide');
        showAlert('×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ: ' + error, 'error');
        currentSyncId = null;
    }
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×‘×××©×§
    function updateSyncStatus(itemId, result) {
        const statusDiv = $(`#sync-status-${itemId}`);
        const lastSyncDiv = $(`#last-sync-${itemId}`);
        
        if (statusDiv.length) {
            statusDiv.html(`
                <small class="text-success">
                    <i class="fas fa-check-circle me-1"></i>
                    ×”×•×©×œ×: ${result.messages_saved} ×”×•×“×¢×•×ª, ${result.events_created} ××™×¨×•×¢×™×
                </small>
            `).show();
        }
        
        // ×¢×“×›×•×Ÿ ×¢××•×“×ª "×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ"
        if (lastSyncDiv.length) {
            const now = new Date().toLocaleString('he-IL');
            lastSyncDiv.html(`
                <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>
                    ${now}
                </span>
                <br>
                <small class="text-muted">
                    ${result.messages_saved} ×”×•×“×¢×•×ª, ${result.events_created} ××™×¨×•×¢×™×
                </small>
            `);
        }
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×§×™×™×
    function loadSyncStatus(itemId) {
        $.get(`/api/sync/status/item/${itemId}`)
            .done(function(status) {
                const lastSyncDiv = $(`#last-sync-${itemId}`);
                const statusDiv = $(`#sync-status-${itemId}`);
                
                if (status.last_sync) {
                    const lastSync = new Date(status.last_sync).toLocaleString('he-IL');
                    const icon = status.success ? 'check-circle text-success' : 'times-circle text-danger';
                    const badgeClass = status.success ? 'bg-success' : 'bg-danger';
                    
                    // ×¢×“×›×•×Ÿ ×¢××•×“×ª "×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ"
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge ${badgeClass}">
                                <i class="fas fa-${status.success ? 'check' : 'times'} me-1"></i>
                                ${lastSync}
                            </span>
                            <br>
                            <small class="text-muted">
                                ${status.messages_count} ×”×•×“×¢×•×ª, ${status.events_count} ××™×¨×•×¢×™×
                            </small>
                        `);
                    }
                    
                    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ (×× ×§×™×™×)
                    if (statusDiv.length) {
                        statusDiv.html(`
                            <small class="${status.success ? 'text-success' : 'text-danger'}">
                                <i class="fas fa-${icon} me-1"></i>
                                ×”×•×©×œ×: ${status.messages_count} ×”×•×“×¢×•×ª, ${status.events_count} ××™×¨×•×¢×™×
                            </small>
                        `).show();
                    }
                } else {
                    // ×× ×œ× ×¡×•× ×›×¨×Ÿ ××¢×•×œ×
                    if (lastSyncDiv.length) {
                        lastSyncDiv.html(`
                            <span class="badge bg-secondary">
                                <i class="fas fa-clock me-1"></i>
                                ×œ× ×¡×•× ×›×¨×Ÿ
                            </span>
                        `);
                    }
                }
            })
            .fail(function() {
                const lastSyncDiv = $(`#last-sync-${itemId}`);
                if (lastSyncDiv.length) {
                    lastSyncDiv.html(`
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ×©×’×™××”
                        </span>
                    `);
                }
            });
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ×œ×›×œ ×”×¤×¨×™×˜×™×
    function loadAllSyncStatus() {
        $('.sync-now').each(function() {
            const itemId = $(this).data('id');
            loadSyncStatus(itemId);
        });
    }
    
    // ×˜×¢×™× ×ª ×¡×˜×˜×•×¡ ×¡×™× ×›×¨×•×Ÿ ××—×¨×™ ×—×™×¤×•×©
    setTimeout(loadAllSyncStatus, 1000);
    
    // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×¦××¦×•× ×—×œ×•×Ÿ ×¡×™× ×›×¨×•×Ÿ
    $('#minimize-sync').on('click', function() {
        $('#progressModal').modal('hide');
        $('#minimized-sync').show();
        isMinimized = true;
    });
    
    $('#restore-sync').on('click', function() {
        $('#minimized-sync').hide();
        $('#progressModal').modal('show');
        isMinimized = false;
    });
    
    // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×œ×•×’
    function addSyncLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('he-IL');
        const logClass = type === 'error' ? 'text-danger' : 
                        type === 'success' ? 'text-success' : 
                        type === 'warning' ? 'text-warning' : 'text-light';
        
        const logEntry = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
        
        // ×”×•×¡×¤×” ×œ×—×œ×•×Ÿ ×”×¨××©×™
        $('#sync-logs').append(logEntry);
        $('#sync-logs').scrollTop($('#sync-logs')[0].scrollHeight);
        
        // ×”×•×¡×¤×” ×œ×—×œ×•×Ÿ ×”××•×§×˜×Ÿ
        if (isMinimized) {
            $('#minimized-progress-text').text(message);
        }
    }
    
    // ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×•×ª ×”×¡×™× ×›×¨×•×Ÿ ×¢× ×œ×•×’×™×
    const originalStartSync = startSync;
    startSync = function(itemId, itemType, startDate, endDate) {
        addSyncLog(`××ª×—×™×œ ×¡×™× ×›×¨×•×Ÿ ${itemType}: ${itemId}`, 'info');
        addSyncLog(`×ª×§×•×¤×”: ${startDate} - ${endDate}`, 'info');
        return originalStartSync(itemId, itemType, startDate, endDate);
    };
    
    const originalUpdateProgress = updateProgress;
    updateProgress = function(status) {
        addSyncLog('××¡× ×›×¨×Ÿ ×”×•×“×¢×•×ª...', 'info');
        return originalUpdateProgress(status);
    };
    
    const originalHandleSyncComplete = handleSyncComplete;
    handleSyncComplete = function(result) {
        if (result.success) {
            addSyncLog(`âœ… ×¡×™× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”!`, 'success');
            addSyncLog(`ğŸ“± ×”×•×“×¢×•×ª ×©× ××¦××•: ${result.messages_found}`, 'success');
            addSyncLog(`ğŸ’¾ ×”×•×“×¢×•×ª ×©× ×©××¨×•: ${result.messages_saved}`, 'success');
            addSyncLog(`ğŸ“… ××™×¨×•×¢×™× ×©× ×•×¦×¨×•: ${result.events_created}`, 'success');
        } else {
            addSyncLog(`âŒ ×¡×™× ×›×¨×•×Ÿ × ×›×©×œ: ${result.error}`, 'error');
        }
        return originalHandleSyncComplete(result);
    };
    
    const originalHandleSyncError = handleSyncError;
    handleSyncError = function(error) {
        addSyncLog(`âŒ ×©×’×™××” ×‘×¡×™× ×›×¨×•×Ÿ: ${error}`, 'error');
        return originalHandleSyncError(error);
    };
});
</script>
{% endblock %}



